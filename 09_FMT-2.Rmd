# Changes after FMT compared to acclimation
```{r knitr_options_FMT2, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=7, fig.fullwidth=TRUE,
fig.path='Figures/', warning=FALSE,
message=FALSE)
set.seed(2802)
```
```{r load_data_FMT2}
load("data/data_27022025.Rdata")
load("data/calculations_28022025.Rdata")
```


## What is the trend of the microbiota in each type after FMT?

### Alpha diversity

```{r alpha_div_plot_all, comment="", message=FALSE, warning=FALSE, fig.height=10, fig.width=8, fig.fullwidth=TRUE}
label_map <- c(
  "Control" = "Cold-control", 
  "Treatment" = "Cold-intervention",
  "richness" = "Species Richness",
  "neutral" = "Neutral Diversity",
  "phylogenetic" = "Phylogenetic Diversity"
)

alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point %in% c("FMT1","Acclimation", "FMT2")) %>%
  mutate(metric = factor(metric, levels = c("richness", "neutral", "phylogenetic"))) %>%
  ggplot(aes(y = value, x = time_point, color = type, fill = type)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.5, show.legend = FALSE) +
  facet_grid(metric ~ type, scales = "free_y", labeller = labeller(metric = label_map, type = label_map))+
#  facet_nested(.~metric+type, labeller = labeller(metric = label_map, type = label_map))+
  scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
      scale_fill_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA50","#d57d2c50","#76b18350")) +
  theme_minimal() +
  theme(axis.text.x=element_text(size=10))+
  labs(x = "Time Point", y = "value")
```

```{r 2}
alpha_div_meta <- alpha_div %>%
  left_join(sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT1"|time_point=="Acclimation"|time_point=="FMT2") 
```

***Richness***
```{r alpha_div_data_post7_comparison, comment="", message=FALSE, warning=FALSE}
Modelq0GLMMNB <- glmer.nb(richness ~ type*time_point+(1|individual), data = alpha_div_meta)
summary(Modelq0GLMMNB)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ type)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ time_point)
```

***Neutral***
```{r alpha_div_data_1_post7_comparison, comment="", message=FALSE, warning=FALSE}
Modelq1n <- nlme::lme(neutral ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta)
summary(Modelq1n)
emmeans::emmeans(Modelq1n, pairwise ~ type)
emmeans::emmeans(Modelq1n, pairwise ~ time_point)
```

***Phylogenetic***
```{r alpha_div_data_2_post7_comparison, comment="", message=FALSE, warning=FALSE}
Model_phylo <- nlme::lme(phylogenetic ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta)
summary(Model_phylo)
emmeans::emmeans(Model_phylo, pairwise ~ type)
emmeans::emmeans(Model_phylo, pairwise ~ time_point)
```

#### Beta diversity

***Number of samples used***
```{r beta_div_neutral_all_samples_2_comparison, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
samples_to_keep_post7 <- sample_metadata %>%
  filter(time_point=="FMT1"|time_point=="Acclimation"|time_point=="FMT2") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post7 <- sample_metadata %>%
  filter(time_point=="FMT1"|time_point=="Acclimation"|time_point=="FMT2")

subset_meta_post7$time_point<-as.factor(subset_meta_post7$time_point)
subset_meta_post7$type<-as.factor(subset_meta_post7$type)
length(samples_to_keep_post7)
```

***Richness***
```{r beta_richness_permanova_post7_2_comparison, warning=FALSE, comments="", message=FALSE}
richness_post7 <- as.matrix(beta_q0n$S)
richness_post7 <- as.dist(richness_post7[rownames(richness_post7) %in% samples_to_keep_post7,
               colnames(richness_post7) %in% samples_to_keep_post7])
betadisper(richness_post7, subset_meta_post7$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post7_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post7 ~ type*time_point,
        data = subset_meta_post7 %>% arrange(match(Tube_code,labels(richness_post7))),
        permutations = 999,
        strata = subset_meta_post7 %>% arrange(match(Tube_code,labels(richness_post7))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post7_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post7_arrange <- column_to_rownames(subset_meta_post7, "Tube_code")
subset_meta_post7_arrange<-subset_meta_post7_arrange[labels(richness_post7),]

pairwise <- pairwise.adonis(richness_post7, subset_meta_post7_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(richness_post7, subset_meta_post7_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Neutral***
```{r beta_neutral_permanova_post7_2_comparison, warning=FALSE, comments="", message=FALSE}
neutral_post7 <- as.matrix(beta_q1n$S)
neutral_post7 <- as.dist(neutral_post7[rownames(neutral_post7) %in% samples_to_keep_post7,
               colnames(neutral_post7) %in% samples_to_keep_post7])
betadisper(neutral_post7, subset_meta_post7$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post7_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post7 ~ type*time_point,
        data = subset_meta_post7 %>% arrange(match(Tube_code,labels(neutral_post7))),
        permutations = 999,
        strata = subset_meta_post7 %>% arrange(match(Tube_code,labels(neutral_post7))) %>% pull(individual),
        by="terms") %>%        
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post7_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post7_arrange <- column_to_rownames(subset_meta_post7, "Tube_code")
subset_meta_post7_arrange<-subset_meta_post7_arrange[labels(neutral_post7),]
pairwise <- pairwise.adonis(neutral_post7, subset_meta_post7$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(neutral_post7, subset_meta_post7_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Phylogenetic***
```{r beta_phylo_permanova_post7_2_comparison, warning=FALSE, comments="", message=FALSE}
phylo_post7 <- as.matrix(beta_q1p$S)
phylo_post7 <- as.dist(phylo_post7[rownames(phylo_post7) %in% samples_to_keep_post7,
               colnames(phylo_post7) %in% samples_to_keep_post7])
betadisper(phylo_post7, subset_meta_post7$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_post7_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post7 ~ type*time_point,
        data = subset_meta_post7 %>% arrange(match(Tube_code,labels(phylo_post7))),
        permutations = 999,
        strata = subset_meta_post7 %>% arrange(match(Tube_code,labels(phylo_post7))) %>% pull(individual),
          by="terms") %>%        
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post7_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post7_arrange <- column_to_rownames(subset_meta_post7, "Tube_code")
subset_meta_post7_arrange<-subset_meta_post7_arrange[labels(phylo_post7),]
pairwise <- pairwise.adonis(phylo_post7, subset_meta_post7_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(phylo_post7, subset_meta_post7_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***dbRDA***
```{r beta_neutral_nmds_post7_comparison, warning=FALSE, comments="", message=FALSE, results="hide"}
#Richness
cca_ord <- capscale(formula = richness_post7 ~ subset_meta_post7$time_point* subset_meta_post7$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post7, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post7$time_pointFMT1" = "FMT1",
                                 "subset_meta_post7$time_pointFMT2"="FMT2",
                                 "subset_meta_post7$typeHot_control"="Warm-control",
                                 "subset_meta_post7$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post7$time_pointFMT1:subset_meta_post7$typeHot_control"="FMT1 Warm-control",
                                 "subset_meta_post7$time_pointFMT2:subset_meta_post7$typeHot_control"="FMT2 Warm-control",
                                 "subset_meta_post7$time_pointFMT1:subset_meta_post7$typeTreatment" = "FMT1 Cold-intervention",
                                 "subset_meta_post7$time_pointFMT2:subset_meta_post7$typeTreatment" = "FMT2 Cold-intervention")

beta_richness_nmds_post7 <-CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
          breaks=c("Control","Hot_control", "Treatment"),
          labels=c("Cold-control","Warm-control", "Cold-intervention"),
          values=c("#4477AA","#d57d2c", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Control","Hot_control", "Treatment"),
          labels=c("Cold-control","Warm-control", "Cold-intervention"),
          values=c("#4477AA50","#d57d2c50","#76b18350")) +
        scale_x_discrete(labels = c("Control" = "Cold-Cold", "Hot_control" = "Hot-Hot", "Treatment" = "Cold-Hot")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()

#Neutral
cca_ord <- capscale(formula = neutral_post7 ~ subset_meta_post7$time_point* subset_meta_post7$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post7, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post7$time_pointFMT1" = "FMT1",
                                 "subset_meta_post7$time_pointFMT2"="FMT2",
                                 "subset_meta_post7$typeHot_control"="Warm-control",
                                 "subset_meta_post7$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post7$time_pointFMT1:subset_meta_post7$typeHot_control"="FMT1 Warm-control",
                                 "subset_meta_post7$time_pointFMT2:subset_meta_post7$typeHot_control"="FMT2 Warm-control",
                                 "subset_meta_post7$time_pointFMT1:subset_meta_post7$typeTreatment" = "FMT1 Cold-intervention",
                                 "subset_meta_post7$time_pointFMT2:subset_meta_post7$typeTreatment" = "FMT2 Cold-intervention")

beta_neutral_nmds_post7 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
          breaks=c("Control","Hot_control", "Treatment"),
          labels=c("Cold-control","Warm-control", "Cold-intervention"),
          values=c("#4477AA","#d57d2c", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Control","Hot_control", "Treatment"),
          labels=c("Cold-control","Warm-control", "Cold-intervention"),
          values=c("#4477AA50","#d57d2c50","#76b18350")) +
        scale_x_discrete(labels = c("Control" = "Cold-Cold", "Hot_control" = "Hot-Hot", "Treatment" = "Cold-Hot")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()


#Phylogenetic
cca_ord <- capscale(formula = phylo_post7 ~ subset_meta_post7$time_point* subset_meta_post7$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post7, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post7$time_pointFMT1" = "FMT1",
                                 "subset_meta_post7$time_pointFMT2"="FMT2",
                                 "subset_meta_post7$typeHot_control"="Warm-control",
                                 "subset_meta_post7$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post7$time_pointFMT1:subset_meta_post7$typeHot_control"="FMT1 Warm-control",
                                 "subset_meta_post7$time_pointFMT2:subset_meta_post7$typeHot_control"="FMT2 Warm-control",
                                 "subset_meta_post7$time_pointFMT1:subset_meta_post7$typeTreatment" = "FMT1 Cold-intervention",
                                 "subset_meta_post7$time_pointFMT2:subset_meta_post7$typeTreatment" = "FMT2 Cold-intervention")

beta_phylogenetic_nmds_post7 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
          breaks=c("Control","Hot_control", "Treatment"),
          labels=c("Cold-control","Warm-control", "Cold-intervention"),
          values=c("#4477AA","#d57d2c", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Control","Hot_control", "Treatment"),
          labels=c("Cold-control","Warm-control", "Cold-intervention"),
          values=c("#4477AA50","#d57d2c50","#76b18350")) +
        scale_x_discrete(labels = c("Control" = "Cold-Cold", "Hot_control" = "Hot-Hot", "Treatment" = "Cold-Hot")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()
```

```{r beta_neutral_nmds_plot_post7_final, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
ggarrange(beta_richness_nmds_post7, beta_neutral_nmds_post7, beta_phylogenetic_nmds_post7, ncol=3, nrow=1, common.legend = TRUE, legend="right")
```


## What is the effect of FMT and temperature on the GM after 1 week compared to acclimation?

### CI vs CC

#### Alpha diversity

```{r alpha_div_plot_6, comment="", message=FALSE, warning=FALSE, fig.height=10, fig.width=8, fig.fullwidth=TRUE}
label_map <- c(
  "Control" = "Cold-control", 
  "Treatment" = "Cold-intervention",
  "richness" = "Species Richness",
  "neutral" = "Neutral Diversity",
  "phylogenetic" = "Phylogenetic Diversity"
)
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(type %in% c("Control","Treatment") & time_point %in% c("FMT1","Acclimation")) %>%
  mutate(metric = factor(metric, levels = c("richness", "neutral", "phylogenetic"))) %>%
  ggplot(aes(y = value, x = time_point, color = type, fill = type)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.5, show.legend = FALSE) +
  facet_grid(metric ~ type, scales = "free_y", labeller = labeller(metric = label_map, type = label_map))+
#  facet_nested(.~metric+type, labeller = labeller(metric = label_map, type = label_map))+
  scale_color_manual(name="Type",
          breaks=c("Control", "Treatment"),
          values=c("#4477AA", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Control", "Treatment"),
          values=c("#4477AA50","#76b18350")) +
  theme_minimal() +
  theme(axis.text.x=element_text(size=10))+
  labs(x = "Time Point", y = "value")
```

```{r}
alpha_div_meta <- alpha_div %>%
  left_join(sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>%
  filter(type!="Hot_control") 
```

***Richness***
```{r alpha_div_data_post3_comparison, comment="", message=FALSE, warning=FALSE}
Modelq0GLMMNB <- glmer.nb(richness ~ type*time_point+(1|individual), data = alpha_div_meta)
summary(Modelq0GLMMNB)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ type)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ time_point)
```

***Neutral***
```{r alpha_div_data_1_post3_comparison, comment="", message=FALSE, warning=FALSE}
Modelq1n <- lme(neutral ~ type*time_point, data = alpha_div_meta,
               random = ~ 1 | individual)
summary(Modelq1n)
emmeans::emmeans(Modelq1n, pairwise ~ type)
emmeans::emmeans(Modelq1n, pairwise ~ time_point)
```

***Phylogenetic***
```{r alpha_div_data_2_post3_comparison, comment="", message=FALSE, warning=FALSE}
Model_phylo <- lme(phylogenetic ~ type*time_point, data = alpha_div_meta,
               random = ~ 1 | individual)
summary(Model_phylo)
emmeans::emmeans(Model_phylo, pairwise ~ type)
emmeans::emmeans(Model_phylo, pairwise ~ time_point)
```

#### Beta diversity

***Number of samples used***
```{r beta_div_neutral_treat1_samples_2_comparison, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
samples_to_keep_post3 <- sample_metadata %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>% 
  filter(type!="Hot_control") %>%
  select(Tube_code) %>% 
  pull()
subset_meta_post3 <- sample_metadata %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>% 
  filter(type!="Hot_control")
subset_meta_post3$time_point<-as.factor(subset_meta_post3$time_point)
subset_meta_post3$type<-as.factor(subset_meta_post3$type)
length(samples_to_keep_post3)
```

***Richness***
```{r beta_richness_permanova_post3_2_comparison, warning=FALSE, comments="", message=FALSE}
richness_post3 <- as.matrix(beta_q0n$S)
richness_post3 <- as.dist(richness_post3[rownames(richness_post3) %in% samples_to_keep_post3,
               colnames(richness_post3) %in% samples_to_keep_post3])
betadisper(richness_post3, subset_meta_post3$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post3_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post3 ~ type*time_point,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(richness_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(richness_post3))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post3_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post3_arrange <- column_to_rownames(subset_meta_post3, "Tube_code")
subset_meta_post3_arrange<-subset_meta_post3_arrange[labels(richness_post3),]

pairwise <- pairwise.adonis(richness_post3, subset_meta_post3_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(richness_post3, subset_meta_post3_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Neutral***
```{r beta_neutral_permanova_post3_2_comparison, warning=FALSE, comments="", message=FALSE}
neutral_post3 <- as.matrix(beta_q1n$S)
neutral_post3 <- as.dist(neutral_post3[rownames(neutral_post3) %in% samples_to_keep_post3,
               colnames(neutral_post3) %in% samples_to_keep_post3])
betadisper(neutral_post3, subset_meta_post3$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post3_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post3 ~ type,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(neutral_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(neutral_post3))) %>% pull(individual),
        by="terms") %>%        
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post3_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post3_arrange <- column_to_rownames(subset_meta_post3, "Tube_code")
subset_meta_post3_arrange<-subset_meta_post3_arrange[labels(neutral_post3),]
pairwise <- pairwise.adonis(neutral_post3, subset_meta_post3_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(neutral_post3, subset_meta_post3_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Phylogenetic***
```{r beta_phylo_permanova_post3_2_comparison, warning=FALSE, comments="", message=FALSE}
phylo_post3 <- as.matrix(beta_q1p$S)
phylo_post3 <- as.dist(phylo_post3[rownames(phylo_post3) %in% samples_to_keep_post3,
               colnames(phylo_post3) %in% samples_to_keep_post3])
betadisper(phylo_post3, subset_meta_post3$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_post3_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post3 ~ type,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(phylo_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(phylo_post3))) %>% pull(individual),
        by="terms") %>%        
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post3_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post3_arrange <- column_to_rownames(subset_meta_post3, "Tube_code")
subset_meta_post3_arrange<-subset_meta_post3_arrange[labels(phylo_post3),]
pairwise <- pairwise.adonis(phylo_post3, subset_meta_post3_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(phylo_post3, subset_meta_post3_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***dbRDA***
```{r beta_neutral_nmds_post3_comparison, warning=FALSE, comments="", message=FALSE, results="hide"}
#Richness
cca_ord <- capscale(formula = richness_post3 ~ subset_meta_post3$time_point* subset_meta_post3$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post3, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post3$time_pointFMT1" = "FMT1",
                                 "subset_meta_post3$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post3$time_pointFMT1:subset_meta_post3$typeTreatment" = "Interaction in Cold-intervention")

beta_richness_nmds_post3 <-CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Treatment"),
                     labels=c("Cold-Cold", "Cold-Hot"),
                     values=c("#4477AA","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()

#Neutral
cca_ord <- capscale(formula = neutral_post3 ~ subset_meta_post3$time_point* subset_meta_post3$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post3, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post3$time_pointFMT1" = "FMT1",
                                 "subset_meta_post3$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post3$time_pointFMT1:subset_meta_post3$typeTreatment" = "Interaction in Cold-intervention")

beta_neutral_nmds_post3 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Treatment"),
                     labels=c("Cold-Cold", "Cold-Hot"),
                     values=c("#4477AA","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()


#Phylogenetic
cca_ord <- capscale(formula = phylo_post3 ~ subset_meta_post3$time_point* subset_meta_post3$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post3, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post3$time_pointFMT1" = "FMT1",
                                 "subset_meta_post3$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post3$time_pointFMT1:subset_meta_post3$typeTreatment" = "Interaction in Cold-intervention")

beta_phylogenetic_nmds_post3 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Treatment"),
                     labels=c("Cold-Cold", "Cold-Hot"),
                     values=c("#4477AA","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()
```

```{r beta_neutral_nmds_plot_post3_final, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
ggarrange(beta_richness_nmds_post3, beta_neutral_nmds_post3, beta_phylogenetic_nmds_post3, ncol=3, nrow=1, common.legend = TRUE, legend="right")
```

### Functional differences

***CC from acclimation to FMT1***

```{r comunity_elem_FMT3_cold, comment="", message=FALSE, warning=FALSE}
element_gift %>%
  filter(time_point %in% c("FMT1","Acclimation") & type == "Control") %>%
  select(-time_point, -type) %>%
  filter(rowSums(across(where(is.numeric), ~ . != 0)) > 0) %>%
  select(Tube_code, where( ~ is.numeric(.) && sum(.) > 0)) %>%
  left_join(sample_metadata[c(1, 10)], by = "Tube_code") %>% 
  pivot_longer(-c(Tube_code, time_point),
               names_to = "trait",
               values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust = p.adjust(p_value, method = "BH")) %>%
  filter(p_adjust < 0.05) %>%
  remove_rownames() %>% 
  left_join(., uniqueGIFT_db, by=join_by("trait"=="Code_element"))
```

***CI from acclimation to FMT1***

```{r comunity_elem_FMT3_cold_1, comment="", message=FALSE, warning=FALSE}
element_gift %>%
  filter(time_point %in% c("FMT1","Acclimation") & type == "Treatment") %>%
  select(-time_point, -type) %>%
  filter(rowSums(across(where(is.numeric), ~ . != 0)) > 0) %>%
  select(Tube_code, where( ~ is.numeric(.) && sum(.) > 0)) %>%
  left_join(sample_metadata[c(1, 10)], by = "Tube_code") %>% 
  pivot_longer(-c(Tube_code, time_point),
               names_to = "trait",
               values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust = p.adjust(p_value, method = "BH")) %>%
  filter(p_adjust < 0.05) %>%
  remove_rownames() %>% 
  left_join(., uniqueGIFT_db, by=join_by("trait"=="Code_element"))
```

### CI vs WC

#### Alpha

```{r alpha_div_plot_9, comment="", message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE}
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>%
  filter(type!="Control") %>%
  mutate(metric = factor(metric, levels = c("richness", "neutral", "phylogenetic"))) %>%
  ggplot(aes(y = value, x = time_point,  color = type, fill = type)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.5) +
  facet_grid(metric ~ type, scales = "free_y", labeller = labeller(metric = label_map, type = label_map))+
  scale_color_manual(name="Type",
          breaks=c("Hot_control", "Treatment"),
          values=c("#d57d2c", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Hot_control", "Treatment"),
          values=c("#d57d2c50","#76b18350")) +
  theme_minimal() +
  theme(axis.text.x=element_text(size=8))+
  labs(x = "Time Point", y = "value")
```

```{r}
alpha_div_meta <- alpha_div %>%
  left_join(sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>%
  filter(type!="Control") 
```

***Richness***
```{r alpha_div_data_post4_comparison, comment="", message=FALSE, warning=FALSE}
Modelq0GLMMNB <- glmer.nb(richness ~ type*time_point+(1|individual), data = alpha_div_meta)
summary(Modelq0GLMMNB)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ type)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ time_point)
```

***Neutral***
```{r alpha_div_data_1_post4_comparison, comment="", message=FALSE, warning=FALSE}
Modelq1n <- lme(neutral ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta,) 
summary(Modelq1n)
emmeans::emmeans(Modelq1n, pairwise ~ type)
emmeans::emmeans(Modelq1n, pairwise ~ time_point)
```

***Phylogenetic***
```{r alpha_div_data_2_post4_comparison, comment="", message=FALSE, warning=FALSE}
Model_phylo <- lme(phylogenetic ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta) 
summary(Model_phylo)
emmeans::emmeans(Model_phylo, pairwise ~ type)
emmeans::emmeans(Model_phylo, pairwise ~ time_point)
```

#### Beta diversity

***Number of samples used***
```{r beta_div_neutral_treat1_samples_2_post4, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
samples_to_keep_post4 <- sample_metadata %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>% 
  filter(type!="Control") %>%
  select(Tube_code) %>% 
  pull()
subset_meta_post4 <- sample_metadata %>%
  filter(time_point=="FMT1"|time_point=="Acclimation") %>% 
  filter(type!="Control")
subset_meta_post4$time_point<-as.factor(subset_meta_post4$time_point)
subset_meta_post4$type<-as.factor(subset_meta_post4$type)
length(samples_to_keep_post4)
```

***Richness***
```{r beta_richness_permanova_post4_2_comparison, warning=FALSE, comments="", message=FALSE}
richness_post4 <- as.matrix(beta_q0n$S)
richness_post4 <- as.dist(richness_post4[rownames(richness_post4) %in% samples_to_keep_post4,
               colnames(richness_post4) %in% samples_to_keep_post4])
betadisper(richness_post4, subset_meta_post4$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post4_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post4 ~ type*time_point,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(richness_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(richness_post4))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post4_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post4_arrange <- column_to_rownames(subset_meta_post4, "Tube_code")
subset_meta_post4_arrange<-subset_meta_post4_arrange[labels(richness_post4),]

pairwise <- pairwise.adonis(richness_post4, subset_meta_post4_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(richness_post4, subset_meta_post4_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Neutral***
```{r beta_neutral_permanova_post4_2_comparison, warning=FALSE, comments="", message=FALSE}
neutral_post4 <- as.matrix(beta_q1n$S)
neutral_post4 <- as.dist(neutral_post4[rownames(neutral_post4) %in% samples_to_keep_post4,
               colnames(neutral_post4) %in% samples_to_keep_post4])
betadisper(neutral_post4, subset_meta_post4$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post4_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post4 ~ type,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(neutral_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(neutral_post4))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post4_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post4_arrange <- column_to_rownames(subset_meta_post4, "Tube_code")
subset_meta_post4_arrange<-subset_meta_post4_arrange[labels(neutral_post4),]
pairwise <- pairwise.adonis(neutral_post4, subset_meta_post4_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(neutral_post4, subset_meta_post4_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Phylogenetic***
```{r beta_phylo_permanova_post4_2_comparison, warning=FALSE, comments="", message=FALSE}
phylo_post4 <- as.matrix(beta_q1p$S)
phylo_post4 <- as.dist(phylo_post4[rownames(phylo_post4) %in% samples_to_keep_post4,
               colnames(phylo_post4) %in% samples_to_keep_post4])
betadisper(phylo_post4, subset_meta_post4$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_post4_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post4 ~ type,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(phylo_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(phylo_post4))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post4_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post4_arrange <- column_to_rownames(subset_meta_post4, "Tube_code")
subset_meta_post4_arrange<-subset_meta_post4_arrange[labels(phylo_post4),]
pairwise <- pairwise.adonis(phylo_post4, subset_meta_post4_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(phylo_post4, subset_meta_post4_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***RDA***
```{r beta_neutral_nmds_post4_comparison, warning=FALSE, comments="", message=FALSE, results="hide"}
#Richness
cca_ord <- capscale(formula = richness_post4 ~ subset_meta_post4$time_point* subset_meta_post4$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post4, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post4$time_pointFMT1" = "FMT1",
                                 "subset_meta_post4$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post4$time_pointFMT1:subset_meta_post4$typeTreatment" = "Interaction in Cold-intervention")

beta_richness_nmds_post4 <-CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                       breaks=c("Hot_control", "Treatment"),
                       labels=c("Warm-control", "Cold-intervention"),
                       values=c("#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()

#Neutral
cca_ord <- capscale(formula = neutral_post4 ~ subset_meta_post4$time_point* subset_meta_post4$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post4, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post4$time_pointFMT1" = "FMT1",
                                 "subset_meta_post4$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post4$time_pointFMT1:subset_meta_post4$typeTreatment" = "Interaction in Cold-intervention")

beta_neutral_nmds_post4 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                       breaks=c("Hot_control", "Treatment"),
                       labels=c("Warm-control", "Cold-intervention"),
                       values=c("#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()


#Phylogenetic
cca_ord <- capscale(formula = phylo_post4 ~ subset_meta_post4$time_point* subset_meta_post4$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post4, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post4$time_pointFMT1" = "FMT1",
                                 "subset_meta_post4$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post4$time_pointFMT1:subset_meta_post4$typeTreatment" = "Interaction in Cold-intervention")

beta_phylogenetic_nmds_post4 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                       breaks=c("Hot_control", "Treatment"),
                       labels=c("Warm-control", "Cold-intervention"),
                       values=c("#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()
```

```{r beta_neutral_nmds_plot_post4_final, fig.height=7}
ggarrange(beta_richness_nmds_post4, beta_neutral_nmds_post4, beta_phylogenetic_nmds_post4, ncol=3, nrow=1, common.legend = TRUE, legend="right")
```

#### Functional differences

***WC from acclimation to FMT1***

```{r comunity_elem_FMT3_cold_2, comment="", message=FALSE, warning=FALSE}
element_gift %>%
  filter(time_point %in% c("FMT1","Acclimation") & type == "Hot_control") %>%
  select(-time_point, -type) %>%
  filter(rowSums(across(where(is.numeric), ~ . != 0)) > 0) %>%
  select(Tube_code, where( ~ is.numeric(.) && sum(.) > 0)) %>%
  left_join(sample_metadata[c(1, 10)], by = "Tube_code") %>% 
  pivot_longer(-c(Tube_code, time_point),
               names_to = "trait",
               values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust = p.adjust(p_value, method = "BH")) %>%
  filter(p_adjust < 0.05) %>%
  remove_rownames() %>% 
  left_join(., uniqueGIFT_db, by=join_by("trait"=="Code_element"))
```

## What is the effect of FMT and temperature on the GM after 2 weeks caompared to acclimation?

### CI vs CC

#### Alpha

```{r alpha_div_plot_10, comment="", message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE}
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(type %in% c("Control","Treatment") & time_point %in% c("FMT2","Acclimation")) %>%
  mutate(metric = factor(metric, levels = c("richness", "neutral", "phylogenetic"))) %>%
  ggplot(aes(y = value, x = time_point, color = type, fill = type)) +
  geom_boxplot(outlier.shape = NA, show.legend = FALSE) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.5, show.legend = FALSE) +
  facet_grid(metric ~ type, scales = "free_y", labeller = labeller(metric = label_map, type = label_map))+
#  facet_nested(.~metric+type, labeller = labeller(metric = label_map, type = label_map))+
  scale_color_manual(name="Type",
          breaks=c("Control", "Treatment"),
          values=c("#4477AA", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Control", "Treatment"),
          values=c("#4477AA50","#76b18350")) +
  theme_minimal() +
  theme(axis.text.x=element_text(size=10))+
  labs(x = "Time Point", y = "value")
```

```{r}
alpha_div_meta <- alpha_div %>%
  left_join(sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>%
  filter(type!="Hot_control") 
```

***Richness***
```{r alpha_div_data_comparison, comment="", message=FALSE, warning=FALSE}
Modelq0GLMMNB <- glmer.nb(richness ~ type*time_point+(1|individual), data = alpha_div_meta)
summary(Modelq0GLMMNB)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ type)
emmeans::emmeans(Modelq0GLMMNB, pairwise ~ time_point)
```

***Neutral***
```{r alpha_div_data_1_comparison, comment="", message=FALSE, warning=FALSE}
Modelq1n <- lme(neutral ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta)  
summary(Modelq1n)
emmeans::emmeans(Modelq1n, pairwise ~ type)
emmeans::emmeans(Modelq1n, pairwise ~ time_point)
```

***Phylogenetic***
```{r alpha_div_data_2_comparison, comment="", message=FALSE, warning=FALSE}
Model_phylo <- lme(phylogenetic ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta)  
summary(Model_phylo)
emmeans::emmeans(Model_phylo, pairwise ~ type)
emmeans::emmeans(Model_phylo, pairwise ~ time_point)
```

#### Beta diversity

***Number of samples used***
```{r beta_div_neutral_treat1_samples_2_comparison_post5, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
samples_to_keep_post5 <- sample_metadata %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>% 
  filter(type!="Hot_control") %>%
  select(Tube_code) %>% 
  pull()
subset_meta_post5 <- sample_metadata %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>% 
  filter(type!="Hot_control")
subset_meta_post5$time_point<-as.factor(subset_meta_post5$time_point)
subset_meta_post5$type<-as.factor(subset_meta_post5$type)
length(samples_to_keep_post5)
```

***Richness***
```{r beta_richness_permanova_post5_2_comparison, warning=FALSE, comments="", message=FALSE}
richness_post5 <- as.matrix(beta_q0n$S)
richness_post5 <- as.dist(richness_post5[rownames(richness_post5) %in% samples_to_keep_post5,
               colnames(richness_post5) %in% samples_to_keep_post5])
betadisper(richness_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post5_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(richness_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(richness_post5))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post5_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post5_arrange <- column_to_rownames(subset_meta_post5, "Tube_code")
subset_meta_post5_arrange<-subset_meta_post5_arrange[labels(richness_post5),]

pairwise <- pairwise.adonis(richness_post5, subset_meta_post5_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(richness_post5, subset_meta_post5_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Neutral***
```{r beta_neutral_permanova_post5_2_comparison, warning=FALSE, comments="", message=FALSE}
neutral_post5 <- as.matrix(beta_q1n$S)
neutral_post5 <- as.dist(neutral_post5[rownames(neutral_post5) %in% samples_to_keep_post5,
               colnames(neutral_post5) %in% samples_to_keep_post5])
betadisper(neutral_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post5_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(neutral_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(neutral_post5))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post5_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post5_arrange <- column_to_rownames(subset_meta_post5, "Tube_code")
subset_meta_post5_arrange<-subset_meta_post5_arrange[labels(neutral_post5),]
pairwise <- pairwise.adonis(neutral_post5, subset_meta_post5_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(neutral_post5, subset_meta_post5_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Phylogenetic***
```{r beta_phylo_permanova_post5_2_comparison, warning=FALSE, comments="", message=FALSE}
phylo_post5 <- as.matrix(beta_q1p$S)
phylo_post5 <- as.dist(phylo_post5[rownames(phylo_post5) %in% samples_to_keep_post5,
               colnames(phylo_post5) %in% samples_to_keep_post5])
betadisper(phylo_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_post5_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(phylo_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(phylo_post5))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post5_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post5_arrange <- column_to_rownames(subset_meta_post5, "Tube_code")
subset_meta_post5_arrange<-subset_meta_post5_arrange[labels(phylo_post5),]
pairwise <- pairwise.adonis(phylo_post5, subset_meta_post5_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(phylo_post5, subset_meta_post5_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***dbRDA***
```{r beta_neutral_nmds_post5_comparison, warning=FALSE, comments="", message=FALSE, results="hide"}
#Richness
cca_ord <- capscale(formula = richness_post5 ~ subset_meta_post5$time_point* subset_meta_post5$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post5, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post5$time_pointFMT2" = "FMT2",
                                 "subset_meta_post5$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post5$time_pointFMT2:subset_meta_post5$typeTreatment" = "Interaction in Cold-intervention")

beta_richness_nmds_post5 <-CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Treatment"),
                     labels=c("Cold-Cold", "Cold-Hot"),
                     values=c("#4477AA","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()

#Neutral
cca_ord <- capscale(formula = neutral_post5 ~ subset_meta_post5$time_point* subset_meta_post5$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post5, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post5$time_pointFMT2" = "FMT2",
                                 "subset_meta_post5$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post5$time_pointFMT2:subset_meta_post5$typeTreatment" = "Interaction in Cold-intervention")

beta_neutral_nmds_post5 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Treatment"),
                     labels=c("Cold-Cold", "Cold-Hot"),
                     values=c("#4477AA","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()


#Phylogenetic
cca_ord <- capscale(formula = phylo_post5 ~ subset_meta_post5$time_point* subset_meta_post5$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post5, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post5$time_pointFMT2" = "FMT2",
                                 "subset_meta_post5$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post5$time_pointFMT2:subset_meta_post5$typeTreatment" = "Interaction in Cold-intervention")

beta_phylogenetic_nmds_post5 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Treatment"),
                     labels=c("Cold-Cold", "Cold-Hot"),
                     values=c("#4477AA","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()
```

```{r beta_neutral_nmds_plot_post5_final, fig.height=7}
ggarrange(beta_richness_nmds_post5, beta_neutral_nmds_post5, beta_phylogenetic_nmds_post5, ncol=3, nrow=1, common.legend = TRUE, legend="right")
```

#### Functional differences

***CC from acclimation to FMT2***

```{r comunity_elem_FMT3_cold_5, comment="", message=FALSE, warning=FALSE}
element_gift %>%
  filter(time_point %in% c("FMT2","Acclimation") & type == "Control") %>%
  select(-time_point, -type) %>%
  filter(rowSums(across(where(is.numeric), ~ . != 0)) > 0) %>%
  select(Tube_code, where( ~ is.numeric(.) && sum(.) > 0)) %>%
  left_join(sample_metadata[c(1, 10)], by = "Tube_code") %>% 
  pivot_longer(-c(Tube_code, time_point),
               names_to = "trait",
               values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust = p.adjust(p_value, method = "BH")) %>%
  filter(p_adjust < 0.05) %>%
  remove_rownames() %>% 
  left_join(., uniqueGIFT_db, by=join_by("trait"=="Code_element"))
```

***CI from acclimation to FMT2***

```{r comunity_elem_FMT3_cold_6, comment="", message=FALSE, warning=FALSE}
element_gift %>%
  filter(time_point %in% c("FMT2","Acclimation") & type == "Treatment") %>%
  select(-time_point, -type) %>%
  filter(rowSums(across(where(is.numeric), ~ . != 0)) > 0) %>%
  select(Tube_code, where( ~ is.numeric(.) && sum(.) > 0)) %>%
  left_join(sample_metadata[c(1, 10)], by = "Tube_code") %>% 
  pivot_longer(-c(Tube_code, time_point),
               names_to = "trait",
               values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust = p.adjust(p_value, method = "BH")) %>%
  filter(p_adjust < 0.05) %>%
  remove_rownames() %>% 
  left_join(., uniqueGIFT_db, by=join_by("trait"=="Code_element"))
```

### CI vs WC

#### Alpha

```{r alpha_div_plot_8, comment="", message=FALSE, warning=FALSE, fig.height=10, fig.width=10, fig.fullwidth=TRUE}
alpha_div %>%
  pivot_longer(-sample, names_to = "metric", values_to = "value") %>%
  left_join(., sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>%
  filter(type!="Control") %>%
  mutate(metric = factor(metric, levels = c("richness", "neutral", "phylogenetic"))) %>%
  ggplot(aes(y = value, x = time_point,  color = type, fill = type)) +
  geom_boxplot(outlier.shape = NA) +
  geom_point(position = position_jitterdodge(jitter.width = 0.2, dodge.width = 0.8), alpha = 0.5) +
  facet_grid(metric ~ type, scales = "free_y", labeller = labeller(metric = label_map, type = label_map))+
  scale_color_manual(name="Type",
          breaks=c("Hot_control", "Treatment"),
          values=c("#d57d2c", "#76b183")) +
      scale_fill_manual(name="Type",
          breaks=c("Hot_control", "Treatment"),
          values=c("#d57d2c50","#76b18350")) +
  theme_minimal() +
  theme(axis.text.x=element_text(size=8))+
  labs(x = "Time Point", y = "value")
```

```{r}
alpha_div_meta <- alpha_div %>%
  left_join(sample_metadata, by = join_by(sample == Tube_code)) %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>%
  filter(type!="Control") 
```

***Richness***
```{r alpha_div_data_post6_comparison, comment="", message=FALSE, warning=FALSE, eval=FALSE}
Modelq0GLMMNB <- glmer.nb(richness ~ type*time_point+(1|individual), data = alpha_div_meta)
summary(Modelq0GLMMNB)
emmeans(Modelq0GLMMNB, pairwise ~ type)
emmeans(Modelq0GLMMNB, pairwise ~ time_point)
```

***Neutral***
```{r alpha_div_data_1_post6_comparison, comment="", message=FALSE, warning=FALSE}
Modelq1n <- lme(neutral ~ type*time_point,
               random = ~ 1 | individual,
               data = alpha_div_meta)   
summary(Modelq1n)
emmeans(Modelq1n, pairwise ~ type)
emmeans(Modelq1n, pairwise ~ time_point)
```

***Phylogenetic***
```{r alpha_div_data_2_post6_comparison, comment="", message=FALSE, warning=FALSE}
Model_phylo <- lme(phylogenetic ~ type*time_point, 
               random = ~ 1 | individual,
               data = alpha_div_meta)   
summary(Model_phylo)
emmeans(Model_phylo, pairwise ~ type)
emmeans(Model_phylo, pairwise ~ time_point)
```

#### Beta diversity

***Number of samples used***
```{r beta_div_neutral_treat1_samples_2_post6, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
samples_to_keep_post6 <- sample_metadata %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>% 
  filter(type!="Control") %>%
  select(Tube_code) %>% 
  pull()
subset_meta_post6 <- sample_metadata %>%
  filter(time_point=="FMT2"|time_point=="Acclimation") %>% 
  filter(type!="Control")
subset_meta_post6$time_point<-as.factor(subset_meta_post6$time_point)
subset_meta_post6$type<-as.factor(subset_meta_post6$type)
length(samples_to_keep_post6)
```

***Richness***
```{r beta_richness_permanova_post6_2_comparison, warning=FALSE, comments="", message=FALSE}
richness_post6 <- as.matrix(beta_q0n$S)
richness_post6 <- as.dist(richness_post6[rownames(richness_post6) %in% samples_to_keep_post6,
               colnames(richness_post6) %in% samples_to_keep_post6])
betadisper(richness_post6, subset_meta_post6$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post6_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post6 ~ type*time_point,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(richness_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(richness_post6))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post6_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post6_arrange <- column_to_rownames(subset_meta_post6, "Tube_code")
subset_meta_post6_arrange<-subset_meta_post6_arrange[labels(richness_post6),]

pairwise <- pairwise.adonis(richness_post6, subset_meta_post6_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(richness_post6, subset_meta_post6_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Neutral***
```{r beta_neutral_permanova_post6_2_comparison, warning=FALSE, comments="", message=FALSE}
neutral_post6 <- as.matrix(beta_q1n$S)
neutral_post6 <- as.dist(neutral_post6[rownames(neutral_post6) %in% samples_to_keep_post6,
               colnames(neutral_post6) %in% samples_to_keep_post6])
betadisper(neutral_post6, subset_meta_post6$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post6_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post6 ~ type,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(neutral_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(neutral_post6))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post6_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post6_arrange <- column_to_rownames(subset_meta_post6, "Tube_code")
subset_meta_post6_arrange<-subset_meta_post6_arrange[labels(neutral_post6),]
pairwise <- pairwise.adonis(neutral_post6, subset_meta_post6_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(neutral_post6, subset_meta_post6_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***Phylogenetic***
```{r beta_phylo_permanova_post6_2_comparison, warning=FALSE, comments="", message=FALSE}
phylo_post6 <- as.matrix(beta_q1p$S)
phylo_post6 <- as.dist(phylo_post6[rownames(phylo_post6) %in% samples_to_keep_post6,
               colnames(phylo_post6) %in% samples_to_keep_post6])
betadisper(phylo_post6, subset_meta_post6$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_post6_1_comparison, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post6 ~ type,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(phylo_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(phylo_post6))) %>% pull(individual),
        by="terms") %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post6_3_comparison, warning=FALSE, comments="", message=FALSE}
subset_meta_post6_arrange <- column_to_rownames(subset_meta_post6, "Tube_code")
subset_meta_post6_arrange<-subset_meta_post6_arrange[labels(phylo_post6),]
pairwise <- pairwise.adonis(phylo_post6, subset_meta_post6_arrange$type, perm=999)
pairwise%>%
  tt()
pairwise <- pairwise.adonis(phylo_post6, subset_meta_post6_arrange$time_point, perm=999)
pairwise%>%
  tt()
```

***dbRDA***
```{r beta_neutral_nmds_post6_comparison, warning=FALSE, comments="", message=FALSE, results="hide"}
#Richness
cca_ord <- capscale(formula = richness_post6 ~ subset_meta_post6$time_point* subset_meta_post6$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post6, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post6$time_pointFMT2" = "FMT2",
                                 "subset_meta_post6$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post6$time_pointFMT2:subset_meta_post6$typeTreatment" = "Interaction in Cold-intervention")

beta_richness_nmds_post6 <-CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                       breaks=c("Hot_control", "Treatment"),
                       labels=c("Warm-control", "Cold-intervention"),
                       values=c("#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()

#Neutral
cca_ord <- capscale(formula = neutral_post6 ~ subset_meta_post6$time_point* subset_meta_post6$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post6, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post6$time_pointFMT2" = "FMT2",
                                 "subset_meta_post6$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post6$time_pointFMT2:subset_meta_post6$typeTreatment" = "Interaction in Cold-intervention")

beta_neutral_nmds_post6 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                       breaks=c("Hot_control", "Treatment"),
                       labels=c("Warm-control", "Cold-intervention"),
                       values=c("#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()


#Phylogenetic
cca_ord <- capscale(formula = phylo_post6 ~ subset_meta_post6$time_point* subset_meta_post6$type)
CAP_df <- as.data.frame(vegan::scores(cca_ord, display = "sites")) %>%
  rownames_to_column('Tube_code') %>%
  left_join(subset_meta_post6, by = 'Tube_code') %>%
  column_to_rownames('Tube_code')%>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE))

biplot_scores <- as.data.frame(vegan::scores(cca_ord, display = "bp")) %>%
  rownames_to_column("Variable")
biplot_scores$Variable <- recode(biplot_scores$Variable, 
                                 "subset_meta_post6$time_pointFMT2" = "FMT2",
                                 "subset_meta_post6$typeTreatment" = "Cold-intervention",
                                 "subset_meta_post6$time_pointFMT2:subset_meta_post6$typeTreatment" = "Interaction in Cold-intervention")

beta_phylogenetic_nmds_post6 <- CAP_df %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(CAP1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(CAP2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=CAP1,y=CAP2, color=type,shape = time_point)) +
  scale_color_manual(name="Type",
                       breaks=c("Hot_control", "Treatment"),
                       labels=c("Warm-control", "Cold-intervention"),
                       values=c("#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_hline(yintercept = 0, linetype = "dotted") + 
  geom_vline(xintercept = 0, linetype = "dotted") +
  geom_segment(aes(x=x_cen, y=y_cen, xend=CAP1, yend=CAP2), alpha=0.2) +
  geom_segment(data = biplot_scores, aes(x = 0, y = 0, xend = CAP1, yend = CAP2),
               inherit.aes = FALSE, arrow = arrow(length = unit(0.2, "cm")), color = "black") +
  geom_text(data = biplot_scores, aes(x = CAP1, y = CAP2, label = Variable),
            inherit.aes = FALSE, color = "black", vjust = -0.5, hjust = 0.5)+
  theme_classic()
```

```{r beta_neutral_nmds_plot_post6_final, fig.height=7}
ggarrange(beta_richness_nmds_post6, beta_neutral_nmds_post6, beta_phylogenetic_nmds_post6, ncol=3, nrow=1, common.legend = TRUE, legend="right")
```

#### Functional differences

***WC from acclimation to FMT2***

```{r comunity_elem_FMT3_cold_post6, comment="", message=FALSE, warning=FALSE}
element_gift %>%
  filter(time_point %in% c("FMT2","Acclimation") & type == "Hot_control") %>%
  select(-time_point, -type) %>%
  filter(rowSums(across(where(is.numeric), ~ . != 0)) > 0) %>%
  select(Tube_code, where( ~ is.numeric(.) && sum(.) > 0)) %>%
  left_join(sample_metadata[c(1, 10)], by = "Tube_code") %>% 
  pivot_longer(-c(Tube_code, time_point),
               names_to = "trait",
               values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust = p.adjust(p_value, method = "BH")) %>%
  filter(p_adjust < 0.05) %>%
  remove_rownames() %>% 
  left_join(., uniqueGIFT_db, by=join_by("trait"=="Code_element"))
```


