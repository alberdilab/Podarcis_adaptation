# Differential abundance functional

```{r load_data_mag_filtdamr_diffe, comment="", echo=FALSE, message=FALSE, warning=FALSE}
load("data/data.Rdata")
```

## Wilcoxon comparison

### Comparison of both population in wild samples ####

```{r comunity_elem_&, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_wild<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_wild[c(1,4)], by="Tube_code") 
```

```{r commun_wilcox_elem_6_filter, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_wild, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_wild[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_wild_filter <- element_gift_wild[, !numeric_cols | colnames(element_gift_wild) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_6, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_wild <- element_gift_wild_filter %>%
  pivot_longer(-c(Tube_code,Population), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ Population)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

element_gift_t_wild <- element_gift_wild_filter  %>% 
  dplyr::select(-c(Population))  %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

element_gift_filt_wild <- subset(element_gift_t_wild, trait %in% significant_elements_wild$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_wild[c(1,4)], by = join_by(Tube_code == Tube_code))

difference_table_wild <- element_gift_filt_wild %>%
  select(-Tube_code) %>%
  group_by(Population) %>%
  summarise(across(everything(), mean)) %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "Elements") %>%
  left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %>% 
  arrange(Function) %>% 
  mutate(Difference=Cold_wet-Hot_dry)%>% 
  mutate(group_color = ifelse(Difference <0, "Hot","Cold")) 
```

```{r log_fold_calc_6, comment="", echo=FALSE, message=FALSE, warning=FALSE}
means_gift_wild <- element_gift_filt_wild %>% 
  select(-Population) %>% 
  pivot_longer(!Tube_code, names_to = "elements", values_to = "abundance") %>% 
  left_join(sample_metadata_wild, by=join_by(Tube_code==Tube_code)) %>% 
  group_by(Population, elements) %>%
  summarise(mean=mean(abundance))

log_fold_wild <- means_gift_wild %>%
  group_by(elements) %>%
  summarise(
    logfc_Cold_hot = log2(mean[Population == "Cold_wet"] / mean[Population == "Hot_dry"])
  )
```


```{r plot1_6, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_wild %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_wild, by=join_by(Elements==trait)) %>% 
  ggplot(., aes(x = Difference, y = -log(p_adjust), color=group_color)) + 
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2)
```

```{r plot3_6, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=10, fig.fullwidth=TRUE}
uniqueGIFT <- unique(GIFT_db2[c(2,3,4,5,6)])

code_function_wild <- difference_table_wild %>%
  left_join(uniqueGIFT[c(1:3)], by=join_by(Elements==Code_element))

unique_codes_wild<-unique(code_function_wild$Code_function)

gift_colors_wild <- read_tsv("data/gift_colors.tsv") %>% 
  filter(Code_function %in% unique_codes_wild)%>% 
  mutate(legend=str_c(Code_function," - ",Function))

code_function_wild %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_wild, by=join_by(Elements==trait)) %>%
  left_join(log_fold_wild, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_wild, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_Cold_hot, y = -log(p_adjust), color=legend, size=abs(Difference))) + #note that p_value was used instead of p_adjust
  geom_point()+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_wild$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value")

# +
#   geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)

```
```{r final_plot_6, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
code_function_wild %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_wild, by=join_by(Elements==trait)) %>%
  left_join(log_fold_wild, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_wild, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_Cold_hot, y = -log(p_adjust), color=legend, size=abs(Difference))) + #note that p_value was used instead of p_adjust
  geom_jitter(width = 0.2, height = 0.2)+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_wild$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value") +
  geom_text_repel(aes(label = Element), min.segment.length = 0.4, size=2.5, max.overlaps = Inf)
```

```{r plot4_6, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_wild %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_wild, by=join_by(Elements==trait)) %>%
  left_join(log_fold_wild, by=join_by(Elements==elements)) %>% 
  ggplot(., aes(x = Difference, y = logfc_Cold_hot, color=group_color)) +
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)
```

```{r commun_wilcox_elem_plot_6, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
difference_table_wild %>%
  ggplot(aes(x=forcats::fct_reorder(Function,Difference), y=Difference, fill=group_color)) + 
  geom_col() +
  #  geom_point(size=4) + 
  scale_fill_manual(values=c("#e5bd5b", "#6b7398")) + 
  geom_hline(yintercept=0) + 
  coord_flip()+
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12),
        legend.position = "right", 
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"))+
  xlab("Function") + 
  ylab("Mean difference")
```

```{r elements_plot_6, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_names_wild <- element_gift_filt_wild%>%
  select(-Population)%>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))%>%
  select(-Elements)%>%
  select(Function, everything())%>%
  t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_wild[c(1,4)], by = join_by(Tube_code == Tube_code))


colNames <- names(element_gift_names_wild)[2:38] #check the column that has the last code
for(i in colNames){
  plt <- ggplot(element_gift_names_wild, aes(x=Population, y=.data[[i]], color = Population, fill=Population)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
    geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
    scale_fill_manual(values=c("#e5bd5b", "#6b7398"))+
    theme_minimal() +
    theme(
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank())
  print(plt)
}

```

### Comparison of both population in acclimation samples ####

```{r comunity_elem_7, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_accli<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_accli[c(1,4)], by="Tube_code") 
```

```{r comunity_elem_7_accli_filter, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_accli, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_accli[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_accli_filter <- element_gift_accli[, !numeric_cols | colnames(element_gift_accli) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_7, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_accli <- element_gift_accli_filter %>%
  pivot_longer(-c(Tube_code,Population), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ Population)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

element_gift_t_accli <- element_gift_accli_filter  %>% 
  dplyr::select(-c(Population))  %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

element_gift_filt_accli <- subset(element_gift_t_accli, trait %in% significant_elements_accli$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_accli[c(1,4)], by = join_by(Tube_code == Tube_code))

difference_table_accli <- element_gift_filt_accli %>%
  select(-Tube_code) %>%
  group_by(Population) %>%
  summarise(across(everything(), mean)) %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "Elements") %>%
  left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %>% 
  arrange(Function) %>% 
  mutate(Difference=Cold_wet-Hot_dry)%>% 
  mutate(group_color = ifelse(Difference <0, "Hot","Cold")) 
```

```{r log_fold_calc_7, comment="", echo=FALSE, message=FALSE, warning=FALSE}
means_gift_accli <- element_gift_filt_accli %>% 
  select(-Population) %>% 
  pivot_longer(!Tube_code, names_to = "elements", values_to = "abundance") %>% 
  left_join(sample_metadata_accli, by=join_by(Tube_code==Tube_code)) %>% 
  group_by(Population, elements) %>%
  summarise(mean=mean(abundance))

log_fold_accli <- means_gift_accli %>%
  group_by(elements) %>%
  summarise(
    logfc_Cold_hot = log2(mean[Population == "Cold_wet"] / mean[Population == "Hot_dry"])
  )
```


```{r plot1_7, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_accli %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_accli, by=join_by(Elements==trait)) %>% 
  ggplot(., aes(x = Difference, y = -log(p_adjust), color=group_color)) + 
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2)
```

```{r plot3_7, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=10, fig.fullwidth=TRUE}
uniqueGIFT <- unique(GIFT_db2[c(2,3,4,5,6)])

code_function_accli <- difference_table_accli %>%
  left_join(uniqueGIFT[c(1:3)], by=join_by(Elements==Code_element))

unique_codes_accli<-unique(code_function_accli$Code_function)

gift_colors_accli <- read_tsv("data/gift_colors.tsv") %>% 
  filter(Code_function %in% unique_codes_accli)%>% 
  mutate(legend=str_c(Code_function," - ",Function))

code_function_accli %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_accli, by=join_by(Elements==trait)) %>%
  left_join(log_fold_accli, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_accli, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_Cold_hot, y = -log(p_adjust), color=legend, size=abs(Difference)))+
  geom_point()+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_accli$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value")

# +
#   geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)

```

```{r final_plot_7, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
code_function_accli %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_accli, by=join_by(Elements==trait)) %>%
  left_join(log_fold_accli, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_accli, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_Cold_hot, y = -log(p_adjust), color=legend, size=abs(Difference))) + #note that p_value was used instead of p_adjust
  geom_jitter(width = 0.2, height = 0.2)+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_accli$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value") +
  geom_text_repel(aes(label = Element), min.segment.length = 0.4, size=2.5, max.overlaps = Inf)
```

```{r plot4_7, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_accli %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_accli, by=join_by(Elements==trait)) %>%
  left_join(log_fold_accli, by=join_by(Elements==elements)) %>% 
  ggplot(., aes(x = Difference, y = logfc_Cold_hot, color=group_color)) +
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)
```

```{r commun_wilcox_elem_plot_10_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
difference_table_accli %>%
  ggplot(aes(x=forcats::fct_reorder(Function,Difference), y=Difference, fill=group_color)) + 
  geom_col() +
  #  geom_point(size=4) + 
  scale_fill_manual(values=c("#e5bd5b", "#6b7398")) + 
  geom_hline(yintercept=0) + 
  coord_flip()+
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12),
        legend.position = "right", 
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"))+
  xlab("Function") + 
  ylab("Mean difference")
```

```{r commun_wilcox_elem_plot_7, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
element_gift_names_accli <- element_gift_filt_accli%>%
  select(-Population)%>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))%>%
  select(-Elements)%>%
  select(Function, everything())%>%
  t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_accli[c(1,4)], by = join_by(Tube_code == Tube_code))


colNames <- names(element_gift_names_accli)[2:17] #check the column that has the last code
for(i in colNames){
  plt <- ggplot(element_gift_names_accli, aes(x=Population, y=.data[[i]], color = Population, fill=Population)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
    geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
    scale_fill_manual(values=c("#e5bd5b", "#6b7398"))+
    theme_minimal() +
    theme(
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank())
  print(plt)
}
```

### Comparison of CC and CI in post1 samples ####

```{r comunity_elem_7_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_post1<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_tm5[c(1,7)], by="Tube_code") 
```

```{r comunity_elem_7_1_filter, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_post1, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_post1[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_post1_filter <- element_gift_post1[, !numeric_cols | colnames(element_gift_post1) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_7_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_post1 <- element_gift_post1_filter %>%
  pivot_longer(-c(Tube_code,type), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ type)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>% #note p_value was used
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

```


### Comparison of CI and WC in post1 samples ####

```{r comunity_elem_7_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_post1_1<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_tm9[c(1,7)], by="Tube_code") 
```

```{r comunity_elem_7_1_filter_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_post1_1, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_post1_1[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_post1_1_filter <- element_gift_post1_1[, !numeric_cols | colnames(element_gift_post1_1) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_7_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_post1_1 <- element_gift_post1_1_filter %>%
  pivot_longer(-c(Tube_code,type), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ type)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>% #note than p_value was used instead of p_adjust
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))
```

### Comparison of CI in accli and post1 samples ####

```{r comunity_elem_8_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
sample_metadata_CI_accli_post1 <- sample_metadata%>% 
  filter(time_point == "5_Post-FMT1" | time_point == "1_Acclimation") %>% 
  filter(type == "Treatment")%>% 
  mutate(time_point = recode(time_point,
                        "1_Acclimation" = "Acclimation", 
                        "5_Post-FMT1" = "Post1"))

element_gift_CI_accli_post1<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_CI_accli_post1[c(1,10)], by="Tube_code") 
```

```{r comunity_elem_8_1_filter_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_CI_accli_post1, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_CI_accli_post1[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_CI_accli_post1_filter <- element_gift_CI_accli_post1[, !numeric_cols | colnames(element_gift_CI_accli_post1) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_7_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_CI_accli_post1 <- element_gift_CI_accli_post1_filter %>%
  pivot_longer(-c(Tube_code,time_point), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

element_gift_t_CI_accli_post1 <- element_gift_CI_accli_post1_filter  %>% 
  dplyr::select(-c(time_point))  %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

element_gift_filt_CI_accli_post1  <- subset(element_gift_t_CI_accli_post1, trait %in% significant_elements_CI_accli_post1$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_CI_accli_post1[c(1,10)], by = join_by(Tube_code == Tube_code))

difference_table_CI_accli_post1 <- element_gift_filt_CI_accli_post1 %>%
  select(-Tube_code) %>%
  group_by(time_point) %>%
  summarise(across(everything(), mean)) %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "Elements") %>%
  left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %>% 
  arrange(Function) %>% 
  mutate(Difference=Acclimation-Post1)%>% 
  mutate(group_color = ifelse(Difference <0, "Post1","Acclimation")) 
```

```{r log_fold_calc_7_1_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
means_gift_CI_accli_post1 <- element_gift_filt_CI_accli_post1 %>% 
  select(-time_point) %>% 
  pivot_longer(!Tube_code, names_to = "elements", values_to = "abundance") %>% 
  left_join(sample_metadata_CI_accli_post1, by=join_by(Tube_code==Tube_code)) %>% 
  group_by(time_point, elements) %>%
  summarise(mean=mean(abundance))

log_fold_CI_accli_post1 <- means_gift_CI_accli_post1 %>%
  group_by(elements) %>%
  summarise(
    logfc_accli_post1 = log2(mean[time_point == "Post1"] / mean[time_point == "Acclimation"])
  )
```


```{r plot1_7_1_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_CI_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI_accli_post1, by=join_by(Elements==trait)) %>% 
  ggplot(., aes(x = Difference, y = -log(p_adjust), color=group_color)) + 
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2)
```

```{r plot3_7_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=10, fig.fullwidth=TRUE}
uniqueGIFT <- unique(GIFT_db2[c(2,3,4,5,6)])

code_function_CI_accli_post1 <- difference_table_CI_accli_post1 %>%
  left_join(uniqueGIFT[c(1:3)], by=join_by(Elements==Code_element))

unique_codes_CI_accli_post1<-unique(code_function_CI_accli_post1$Code_function)

gift_colors_CI_accli_post1 <- read_tsv("data/gift_colors.tsv") %>% 
  filter(Code_function %in% unique_codes_CI_accli_post1)%>% 
  mutate(legend=str_c(Code_function," - ",Function))

code_function_CI_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI_accli_post1, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CI_accli_post1, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_CI_accli_post1, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_accli_post1, y = -log(p_adjust), color=legend, size=abs(Difference))) +
  geom_point()+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_CI_accli_post1$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log p_adjust-value")

# +
#   geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)

```

```{r final_plot_7_1_3, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
code_function_CI_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI_accli_post1, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CI_accli_post1, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_CI_accli_post1, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_accli_post1, y = -log(p_adjust), color=legend, size=abs(Difference))) +
  geom_jitter(width = 0.2, height = 0.2)+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_CI_accli_post1$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log p_adjust-value") +
  geom_text_repel(aes(label = Element), min.segment.length = 0.4, size=2.5, max.overlaps = Inf)
```

```{r plot4_7_1_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_CI_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_post1_1, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CI_accli_post1, by=join_by(Elements==elements)) %>% 
  ggplot(., aes(x = Difference, y = logfc_accli_post1, color=group_color)) +
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)
```

```{r commun_wilcox_elem_plot_10_1_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
difference_table_CI_accli_post1 %>%
  ggplot(aes(x=forcats::fct_reorder(Function,Difference), y=Difference, fill=group_color)) + 
  geom_col() +
  #  geom_point(size=4) + 
  scale_fill_manual(values=c("#e5bd5b", "#6b7398")) + 
  geom_hline(yintercept=0) + 
  coord_flip()+
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12),
        legend.position = "right", 
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"))+
  xlab("Function") + 
  ylab("Mean difference")
```

```{r commun_wilcox_elem_plot_7_1_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
element_gift_names_CI_accli_post1 <- element_gift_filt_CI_accli_post1%>%
  select(-time_point)%>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))%>%
  select(-Elements)%>%
  select(Function, everything())%>%
  t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_CI_accli_post1[c(1,10)], by = join_by(Tube_code == Tube_code))


colNames <- names(element_gift_names_CI_accli_post1)[2:2] #check the column that has the last code
for(i in colNames){
  plt <- ggplot(element_gift_names_CI_accli_post1, aes(x=time_point, y=.data[[i]], color = time_point, fill=time_point)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
    geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
    scale_fill_manual(values=c("#e5bd5b", "#6b7398"))+
    theme_minimal() +
    theme(
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank())
  print(plt)
}
```


### Comparison of CC in accli and post1 samples ####

```{r comunity_elem_9_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
sample_metadata_CC_accli_post1 <- sample_metadata%>% 
  filter(time_point == "5_Post-FMT1" | time_point == "1_Acclimation") %>% 
  filter(type == "Control")%>% 
  mutate(time_point = recode(time_point,
                        "1_Acclimation" = "Acclimation", 
                        "5_Post-FMT1" = "Post1"))

element_gift_CC_accli_post1<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_CC_accli_post1[c(1,10)], by="Tube_code") 
```

```{r comunity_elem_9_1_filter_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_CC_accli_post1, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_CC_accli_post1[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_CC_accli_post1_filter <- element_gift_CC_accli_post1[, !numeric_cols | colnames(element_gift_CC_accli_post1) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_9_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_CC_accli_post1 <- element_gift_CC_accli_post1_filter %>%
  pivot_longer(-c(Tube_code,time_point), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>% #note than p_value was used instead of p_adjust
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

element_gift_t_CC_accli_post1 <- element_gift_CC_accli_post1_filter  %>% 
  dplyr::select(-c(time_point))  %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

element_gift_filt_CC_accli_post1  <- subset(element_gift_t_CC_accli_post1, trait %in% significant_elements_CC_accli_post1$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_CC_accli_post1[c(1,10)], by = join_by(Tube_code == Tube_code))

difference_table_CC_accli_post1 <- element_gift_filt_CC_accli_post1 %>%
  select(-Tube_code) %>%
  group_by(time_point) %>%
  summarise(across(everything(), mean)) %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "Elements") %>%
  left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %>% 
  arrange(Function) %>% 
  mutate(Difference=Acclimation-Post1)%>% 
  mutate(group_color = ifelse(Difference <0, "Post1","Acclimation")) 
```

```{r log_fold_calc_7_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
means_gift_CC_accli_post1 <- element_gift_filt_CC_accli_post1 %>% 
  select(-time_point) %>% 
  pivot_longer(!Tube_code, names_to = "elements", values_to = "abundance") %>% 
  left_join(sample_metadata_CC_accli_post1, by=join_by(Tube_code==Tube_code)) %>% 
  group_by(time_point, elements) %>%
  summarise(mean=mean(abundance))

log_fold_CC_accli_post1 <- means_gift_CC_accli_post1 %>%
  group_by(elements) %>%
  summarise(
    logfc_accli_post1 = log2(mean[time_point == "Acclimation"] / mean[time_point == "Post1"])
  )
```


```{r plot1_7_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_CC_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CC_accli_post1, by=join_by(Elements==trait)) %>% 
  ggplot(., aes(x = Difference, y = -log(p_adjust), color=group_color)) + 
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2)
```

```{r plot3_7_1_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=10, fig.fullwidth=TRUE}
uniqueGIFT <- unique(GIFT_db2[c(2,3,4,5,6)])

code_function_CC_accli_post1 <- difference_table_CC_accli_post1 %>%
  left_join(uniqueGIFT[c(1:3)], by=join_by(Elements==Code_element))

unique_codes_CC_accli_post1<-unique(code_function_CC_accli_post1$Code_function)

gift_colors_CC_accli_post1<- read_tsv("data/gift_colors.tsv") %>% 
  filter(Code_function %in% unique_codes_CC_accli_post1)%>% 
  mutate(legend=str_c(Code_function," - ",Function))

code_function_CC_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CC_accli_post1, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CC_accli_post1, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_CC_accli_post1, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_accli_post1, y = -log(p_adjust), color=legend, size=abs(Difference))) +
  geom_point()+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_CC_accli_post1$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log p_adjust-value")

# +
#   geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)

```

```{r final_plot_7_1_2, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
code_function_CC_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CC_accli_post1, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CC_accli_post1, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_CC_accli_post1, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_accli_post1, y = -log(p_adjust), color=legend, size=abs(Difference))) + #note that p_value was used instead of p_adjust
  geom_jitter(width = 0.2, height = 0.2)+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_CC_accli_post1$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log p_adjust-value") +
  geom_text_repel(aes(label = Element), min.segment.length = 0.4, size=2.5, max.overlaps = Inf)
```

```{r plot4_7_1_3, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_CC_accli_post1 %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CC_accli_post1, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CC_accli_post1, by=join_by(Elements==elements)) %>% 
  ggplot(., aes(x = Difference, y = logfc_accli_post1, color=group_color)) +
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)
```

```{r commun_wilcox_elem_plot_10_1_3, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
difference_table_CC_accli_post1 %>%
  ggplot(aes(x=forcats::fct_reorder(Function,Difference), y=Difference, fill=group_color)) + 
  geom_col() +
  #  geom_point(size=4) + 
  scale_fill_manual(values=c("#e5bd5b", "#6b7398")) + 
  geom_hline(yintercept=0) + 
  coord_flip()+
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12),
        legend.position = "right", 
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"))+
  xlab("Function") + 
  ylab("Mean difference")
```

```{r commun_wilcox_elem_plot_7_1_3, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE}
element_gift_names_CC_accli_post1 <- element_gift_filt_CC_accli_post1%>%
  select(-time_point)%>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))%>%
  select(-Elements)%>%
  select(Function, everything())%>%
  t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., sample_metadata_CC_accli_post1[c(1,10)], by = join_by(Tube_code == Tube_code))


colNames <- names(element_gift_names_CC_accli_post1)[2:10] #check the column that has the last code
for(i in colNames){
  plt <- ggplot(element_gift_names_CC_accli_post1, aes(x=time_point, y=.data[[i]], color = time_point, fill=time_point)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
    geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
    scale_fill_manual(values=c("#e5bd5b", "#6b7398"))+
    theme_minimal() +
    theme(
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank())
  print(plt)
}
```

### Comparison of CI and WC in post2 samples ####

```{r comunity_elem_3_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_post2_1<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_TM8[c(1,7)], by="Tube_code") 
```

```{r comunity_elem_3_1_filter_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_post2_1, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_post2_1[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_post2_1_filter <- element_gift_post2_1[, !numeric_cols | colnames(element_gift_post2_1) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_3_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_post2_1 <- element_gift_post2_1_filter %>%
  pivot_longer(-c(Tube_code,type), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ type)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>% #note than p_value was used instead of p_adjust
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))
```

### Comparison of CI and CC in post2 samples ####

```{r comunity_elem_6_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_post2_2<- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(sample_metadata_TM6[c(1,7)], by="Tube_code") 
```

```{r comunity_elem_6_1_filter_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_post2_2, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_post2_2[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_post2_2_filter <- element_gift_post2_2[, !numeric_cols | colnames(element_gift_post2_2) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_6_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_post2_2 <- element_gift_post2_2_filter %>%
  pivot_longer(-c(Tube_code,type), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ type)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>% #note than p_value was used instead of p_adjust
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))
```

### Community elements differences: in CC acclimation vs post2 ####

```{r comunity_elem, comment="", echo=FALSE, message=FALSE, warning=FALSE}
samples_CC <- sample_metadata%>%
  filter(type=="Control") %>% 
  filter(time_point == "1_Acclimation"|time_point == "6_Post-FMT2")%>% 
  mutate(time_point = recode(time_point,
                        "1_Acclimation" = "Acclimation", 
                        "6_Post-FMT2" = "Post2"))

element_gift_CC <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(samples_CC[c(1,10)], by="Tube_code") 
```

```{r comunity_elem_filter, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_CC, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_CC[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_CC_filter <- element_gift_CC[, !numeric_cols | colnames(element_gift_CC) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_CC <- element_gift_CC_filter %>%
  pivot_longer(-c(Tube_code,time_point), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>% #note that p_value is used instead of p_adjust
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))
```


### Community elements differences: in CI acclimation vs post2 ####

```{r comunity_elem_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
samples_CI <- sample_metadata%>%
  filter(type=="Treatment") %>% 
  filter(time_point == "1_Acclimation"|time_point == "6_Post-FMT2")%>% 
  mutate(time_point = recode(time_point,
                             "1_Acclimation" = "Acclimation", 
                             "6_Post-FMT2" = "Post2"))

element_gift_CI <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(samples_CI[c(1,10)], by="Tube_code") 
```

```{r comunity_elem_1_filter, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_CI, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_CI[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_CI_filter <- element_gift_CI[, !numeric_cols | colnames(element_gift_CI) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_CI <- element_gift_CI_filter %>%
  pivot_longer(-c(Tube_code,time_point), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_adjust < 0.05)%>%
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))

element_gift_t_CI <- element_gift_CI_filter  %>% 
  dplyr::select(-c(time_point))  %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "trait")

element_gift_filt_CI <- subset(element_gift_t_CI, trait %in% significant_elements_CI$trait) %>% 
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., samples_CI[c(1,10)], by = join_by(Tube_code == Tube_code))

difference_table_CI <- element_gift_filt_CI %>%
  select(-Tube_code) %>%
  group_by(time_point) %>%
  summarise(across(everything(), mean)) %>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric) %>%
  rownames_to_column(., "Elements") %>%
  left_join(.,uniqueGIFT_db[c(1,3,4)],by = join_by(Elements == Code_element)) %>% 
  arrange(Function) %>% 
  mutate(Difference=Acclimation-Post2)%>% 
  mutate(group_color = ifelse(Difference <0, "Post2","Acclimation")) 
```

```{r log_fold_calc_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
means_gift_CI <- element_gift_filt_CI %>% 
  select(-time_point) %>% 
  pivot_longer(!Tube_code, names_to = "elements", values_to = "abundance") %>% 
  left_join(samples_CI, by=join_by(Tube_code==Tube_code)) %>% 
  group_by(time_point, elements) %>%
  summarise(mean=mean(abundance))

log_fold_CI <- means_gift_CI %>%
  group_by(elements) %>%
  summarise(
    logfc_acclimation_post2 = log2(mean[time_point == "Acclimation"] / mean[time_point == "Post2"])
  )
```


```{r plot1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE, eval=TRUE}
difference_table_CI %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI, by=join_by(Elements==trait)) %>% 
  ggplot(., aes(x = Difference, y = -log(p_adjust), color=group_color)) + 
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2)
```

```{r plot3_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=5, fig.width=10, fig.fullwidth=TRUE}
uniqueGIFT <- unique(GIFT_db2[c(2,3,4,5,6)])

code_function_CI <- difference_table_CI %>%
  left_join(uniqueGIFT[c(1:3)], by=join_by(Elements==Code_element))

unique_codes_CI<-unique(code_function_CI$Code_function)

gift_colors_CI <- read_tsv("data/gift_colors.tsv") %>% 
  filter(Code_function %in% unique_codes_CI)%>% 
  mutate(legend=str_c(Code_function," - ",Function))

code_function_CI %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CI, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_CI, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_acclimation_post2, y = -log(p_adjust), color=legend, size=abs(Difference))) +
  geom_point()+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_CI$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value")

# +
#   geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)

```
```{r final_plot_1_1_1_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=12, fig.fullwidth=TRUE}
code_function_CI %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CI, by=join_by(Elements==elements)) %>% 
  left_join(gift_colors_CI, by=join_by(Code_function==Code_function)) %>% 
  ggplot(., aes(x = logfc_acclimation_post2, y = -log(p_adjust), color=legend, size=abs(Difference))) + 
  geom_jitter(width = 0.2, height = 0.2)+
  geom_vline(xintercept=0) +
  scale_color_manual(values = gift_colors_CI$Color)+
  #xlim(c(-10,4)) +
  theme_classic()+
  labs(size="Mean difference (abs)", color="Functional trait")+
  labs(x = "Log-fold change", y="-Log adjusted p-value") +
  geom_text_repel(aes(label = Element), min.segment.length = 0.4, size=2.5, max.overlaps = Inf)
```

```{r plot4_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
difference_table_CI %>%
  #  mutate(Difference_abs = abs(Difference)) %>% 
  left_join(significant_elements_CI, by=join_by(Elements==trait)) %>%
  left_join(log_fold_CI, by=join_by(Elements==elements)) %>% 
  ggplot(., aes(x = Difference, y = logfc_acclimation_post2, color=group_color)) +
  geom_point(size=2, show.legend = FALSE) + 
  scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
  #xlim(c(-10,4)) +
  theme_classic()+
  geom_text_repel(aes(label = Elements), size=2, max.overlaps = Inf)
```

```{r commun_wilcox_elem_plot_1, comment="", echo=FALSE, message=FALSE, warning=FALSE, fig.height=6, fig.width=12, fig.fullwidth=TRUE, eval=TRUE}
difference_table_CI %>%
  ggplot(aes(x=forcats::fct_reorder(Function,Difference), y=Difference, fill=group_color)) + 
  geom_col() +
  #  geom_point(size=4) + 
  scale_fill_manual(values=c("#e5bd5b", "#6b7398")) + 
  geom_hline(yintercept=0) + 
  coord_flip()+
  theme(axis.text = element_text(size = 10),
        axis.title = element_text(size = 12),
        legend.position = "right", 
        legend.title = element_blank(),
        panel.background = element_blank(),
        panel.grid.major = element_line(size = 0.15, linetype = 'solid',
                                        colour = "grey"))+
  xlab("Function") + 
  ylab("Mean difference")
```


```{r elements_plot_1, comment="", echo=FALSE, message=FALSE, warning=FALSE}
element_gift_names_CI <- element_gift_filt_CI%>%
  select(-time_point)%>%
  t() %>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Elements")  %>%
  left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(Elements == Code_element))%>%
  select(-Elements)%>%
  select(Function, everything())%>%
  t()%>%
  row_to_names(row_number = 1) %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)  %>%
  rownames_to_column(., "Tube_code")%>% 
  left_join(., samples_CI[c(1,10)], by = join_by(Tube_code == Tube_code))


colNames <- names(element_gift_names_CI)[2:17] #check the column that has the last code
for(i in colNames){
  plt <- ggplot(element_gift_names_CI, aes(x=time_point, y=.data[[i]], color = time_point, fill=time_point)) +
    geom_boxplot(alpha = 0.2, outlier.shape = NA, width = 0.3, show.legend = FALSE) +
    geom_jitter(width = 0.1, show.legend = TRUE) +
    scale_color_manual(values=c("#e5bd5b", "#6b7398"))+
    scale_fill_manual(values=c("#e5bd5b50", "#6b739850"))+
    theme_minimal() +
    theme(
      axis.line = element_line(size = 0.5, linetype = "solid", colour = "black"),
      panel.grid.major = element_blank(),
      panel.grid.minor = element_blank(),
      panel.border = element_blank())
  print(plt)
}

```

### Community elements differences: in WC acclimation vs post2 ####
```{r comunity_elem_2, comment="", echo=FALSE, message=FALSE, warning=FALSE}
samples_WC <- sample_metadata%>%
  filter(type=="Hot_control") %>% 
  filter(time_point == "1_Acclimation"|time_point == "6_Post-FMT2")%>% 
  mutate(time_point = recode(time_point,
                             "1_Acclimation" = "Acclimation", 
                             "6_Post-FMT2" = "Post2"))

element_gift_WC <- GIFTs_elements_community %>% 
  as.data.frame() %>% 
  rownames_to_column(., "Tube_code") %>% 
  inner_join(samples_WC[c(1,10)], by="Tube_code") 
```

```{r comunity_elem_2_filter, comment="", echo=FALSE, message=FALSE, warning=FALSE}
# Find numeric columns
numeric_cols <- sapply(element_gift_WC, is.numeric)

# Calculate column sums for numeric columns only
col_sums_numeric <- colSums(element_gift_WC[, numeric_cols])

# Identify numeric columns with sums not equal to zero
nonzero_numeric_cols <- names(col_sums_numeric)[col_sums_numeric != 0]

# Remove numeric columns with sums not equal to zero
element_gift_WC_filter <- element_gift_WC[, !numeric_cols | colnames(element_gift_WC) %in% nonzero_numeric_cols]
```

```{r commun_wilcox_elem_2, comment="", echo=FALSE, message=FALSE, warning=FALSE}
uniqueGIFT_db<- unique(GIFT_db2[c(2,4,5,6)]) %>% unite("Function",Function:Element, sep= "_", remove=FALSE)

significant_elements_WC <- element_gift_WC_filter %>%
  pivot_longer(-c(Tube_code,time_point), names_to = "trait", values_to = "value") %>%
  group_by(trait) %>%
  summarise(p_value = wilcox.test(value ~ time_point)$p.value) %>%
  mutate(p_adjust=p.adjust(p_value, method="BH")) %>%
  filter(p_value < 0.05)%>% #note that p_value is used instead of p_adjust
  rownames_to_column(., "Elements")  %>% 
  select(-Elements)
# %>%
#   left_join(.,uniqueGIFT_db[c(1,3)],by = join_by(trait == Code_element))
```

