## Permanovas

```{r knitr_options, include=FALSE}
knitr::opts_chunk$set(fig.width=10, fig.height=7, fig.fullwidth=TRUE,
fig.path='Figures/', warning=FALSE,
message=FALSE)
set.seed(1802)
```


#### Load required data

### 1. Are the wild populations similar?

#### Wild: cold vs warm adapted lizards

##### Number of samples used

```{r beta_div_neutral_wild_samples, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(wild)

samples_to_keep <- sample_metadata %>%
  filter(time_point == "0_Wild") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta <- sample_metadata %>%
  filter(time_point == "0_Wild")
```

#### Richness

```{r beta_richness_permanova_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness <- as.matrix(beta_q0n$S)
richness <- as.dist(richness[rownames(richness) %in% samples_to_keep,
               colnames(richness) %in% samples_to_keep])
betadisper(richness, subset_meta$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(richness ~ Population,
        data = subset_meta %>% arrange(match(Tube_code,labels(richness))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

#### Neutral

```{r beta_neutral_permanova_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral <- as.matrix(beta_q1n$S)
neutral <- as.dist(neutral[rownames(neutral) %in% samples_to_keep,
               colnames(neutral) %in% samples_to_keep])
betadisper(neutral, subset_meta$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(neutral ~ Population,
        data = subset_meta %>% arrange(match(Tube_code,labels(neutral))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

#### Phylogenetic

```{r beta_phylo_permanova_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo <- as.matrix(beta_q1p$S)
phylo <- as.dist(phylo[rownames(phylo) %in% samples_to_keep,
               colnames(phylo) %in% samples_to_keep])
betadisper(phylo, subset_meta$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(phylo ~ Population,
        data = subset_meta %>% arrange(match(Tube_code,labels(phylo))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

#### Functional

```{r beta_func_permanova_!, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func <- as.matrix(beta_q1f$S)
func <- as.dist(func[rownames(func) %in% samples_to_keep,
               colnames(func) %in% samples_to_keep])
betadisper(func, subset_meta$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_func_permanova, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(func ~ Population,
        data = subset_meta %>% arrange(match(Tube_code,labels(func))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_nmds, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_q0n_nmds_wild <- richness %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE, trace=FALSE) %>%
				vegan::scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta, by = join_by(sample == Tube_code))

beta_q1n_nmds_wild <- neutral %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE, trace=FALSE) %>%
				vegan::scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta, by = join_by(sample == Tube_code))

beta_q1p_nmds_wild <- phylo %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				vegan::scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta, by = join_by(sample == Tube_code))

beta_q1f_nmds_wild <- func %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				vegan::scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_plot, echo=FALSE, results=TRUE}
p0<-beta_q0n_nmds_wild %>%
			group_by(Population) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population)) +
				scale_color_manual(name="Population",
                    breaks=c("Cold_wet","Hot_dry"),
                    labels=c("Cold","Hot"),
                    values=c('#008080',"#d57d2c")) +
        scale_shape_manual(name="Type",
                           breaks=c("Control", "Hot_control", "Treatment"),
                           labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                         values=c("circle","square","triangle")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p1<-beta_q1n_nmds_wild %>%
			group_by(Population) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, shape=type)) +
				scale_color_manual(name="Population",
                    breaks=c("Cold_wet","Hot_dry"),
                    labels=c("Cold","Hot"),
                    values=c('#008080',"#d57d2c")) +
        scale_shape_manual(name="Type",
                           breaks=c("Control", "Hot_control", "Treatment"),
                           labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                         values=c("circle","square","triangle")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p2<-beta_q1p_nmds_wild %>%
			group_by(Population) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population)) +
				scale_color_manual(name="Population",
                    breaks=c("Cold_wet","Hot_dry"),
                    labels=c("Cold","Hot"),
                    values=c('#008080',"#d57d2c")) +
        scale_shape_manual(name="Type",
                           breaks=c("Control", "Hot_control", "Treatment"),
                           labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                         values=c("circle","square","triangle")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (),x="NMDS1 \n Phylogenetic beta diversity") +
				theme_classic() +
				theme(legend.position="none") 

p3<-beta_q1f_nmds_wild %>%
			group_by(Population) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, label=sample)) +
				scale_color_manual(name="Population",
                    breaks=c("Cold_wet","Hot_dry"),
                    labels=c("Cold","Hot"),
                    values=c('#008080',"#d57d2c")) +
        scale_shape_manual(name="Type",
                           breaks=c("Control", "Hot_control", "Treatment"),
                           labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                         values=c("circle","square","triangle")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
				theme_classic() +
				theme(legend.position="none") +
				guides(color=guide_legend(title="Species"))
```

```{r beta_neutral_nmds_plot_final, echo=FALSE, results=TRUE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```

### 2. Effect of acclimation
##### Number of samples used

```{r beta_div_neutral_accli_samples, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(accli)

samples_to_keep_accli <- sample_metadata %>%
  filter(time_point == "1_Acclimation") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_accli <- sample_metadata %>%
  filter(time_point == "1_Acclimation")
```

#### Richness

```{r beta_richness_permanova_1_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_accli <- as.matrix(beta_q0n$S)
richness_accli <- as.dist(richness_accli[rownames(richness_accli) %in% samples_to_keep_accli,
               colnames(richness_accli) %in% samples_to_keep_accli])
betadisper(richness_accli, subset_meta_accli$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(richness_accli ~ Population,
        data = subset_meta_accli %>% arrange(match(Tube_code,labels(richness_accli))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

#### Neutral

```{r beta_neutral_permanova_1_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_accli <- as.matrix(beta_q1n$S)
neutral_accli <- as.dist(neutral_accli[rownames(neutral_accli) %in% samples_to_keep_accli,
               colnames(neutral_accli) %in% samples_to_keep_accli])
betadisper(neutral_accli, subset_meta_accli$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(neutral_accli ~ Population,
        data = subset_meta_accli %>% arrange(match(Tube_code,labels(neutral_accli))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

#### Phylogenetic

```{r beta_phylo_permanova_1_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_accli <- as.matrix(beta_q1p$S)
phylo_accli <- as.dist(phylo_accli[rownames(phylo_accli) %in% samples_to_keep_accli,
               colnames(phylo_accli) %in% samples_to_keep_accli])
betadisper(phylo_accli, subset_meta_accli$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(phylo_accli ~ Population,
        data = subset_meta_accli %>% arrange(match(Tube_code,labels(phylo_accli))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

#### Functional

```{r beta_func_permanova_accli_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_accli <- as.matrix(beta_q1f$S)
func_accli <- as.dist(func_accli[rownames(func_accli) %in% samples_to_keep_accli,
               colnames(func_accli) %in% samples_to_keep_accli])
betadisper(func_accli, subset_meta_accli$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_func_permanova_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE, results=TRUE}
adonis2(func_accli ~ Population,
        data = subset_meta_accli %>% arrange(match(Tube_code,labels(func_accli))),
        permutations = 999) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_nmds_accli, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_q0n_nmds_accli <- richness_accli %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE, trace=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_accli, by = join_by(sample == Tube_code))

beta_q1n_nmds_accli <- neutral_accli %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE, trace=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_accli, by = join_by(sample == Tube_code))

beta_q1p_nmds_accli <- phylo_accli %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_accli, by = join_by(sample == Tube_code))

beta_q1f_nmds_accli <- func_accli %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  vegan::scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_accli, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_plot_accli, echo=FALSE, results=TRUE}
p0<-beta_q0n_nmds_accli %>%
  group_by(Population) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=Population)) +
  scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
  scale_shape_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("circle","square","triangle")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p1<-beta_q1n_nmds_accli %>%
  group_by(Population) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, shape=type)) +
  scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
  scale_shape_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("circle","square","triangle")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p2<-beta_q1p_nmds_accli %>%
  group_by(Population) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=Population)) +
  scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
  scale_shape_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("circle","square","triangle")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (),x="NMDS1 \n Phylogenetic beta diversity") +
  theme_classic() +
  theme(legend.position="none") 

p3<-beta_q1f_nmds_accli %>%
  group_by(Population) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, label=sample)) +
  scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
  scale_shape_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("circle","square","triangle")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
  theme_classic() +
  theme(legend.position="none") +
  guides(color=guide_legend(title="Species"))
```

```{r beta_neutral_nmds_plot_final_accli, echo=FALSE, results=TRUE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```

### 3. Comparison between Wild and Acclimation
##### Number of samples used

```{r beta_div_neutral_accli1_samples, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(accli1)
samples_to_keep_accli1 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "0_Wild") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_accli1 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "0_Wild")

subset_meta_accli1$Population_time <- interaction(subset_meta_accli1$Population, subset_meta_accli1$time_point)
```

##### Richness

```{r beta_div_richness_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_accli1 <- as.matrix(beta_q0n$S)
richness_accli1 <- as.dist(richness_accli1[rownames(richness_accli1) %in% samples_to_keep_accli1,
               colnames(richness_accli1) %in% samples_to_keep_accli1])
betadisper(richness_accli1, subset_meta_accli1$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_richness_accli1_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_accli1 ~ Population*time_point,
        data = subset_meta_accli1 %>% arrange(match(Tube_code,labels(richness_accli1))),
        permutations = 999,
        strata = subset_meta_accli1 %>% arrange(match(Tube_code,labels(richness_accli1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_accli1_arrange <- column_to_rownames(subset_meta_accli1, "Tube_code")
subset_meta_accli1_arrange<-subset_meta_accli1_arrange[labels(richness_accli1),]

pairwise<-pairwise.adonis(richness_accli1,subset_meta_accli1_arrange$Population_time, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_div_neutral_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_accli1 <- as.matrix(beta_q1n$S)
neutral_accli1 <- as.dist(neutral_accli1[rownames(neutral_accli1) %in% samples_to_keep_accli1,
               colnames(neutral_accli1) %in% samples_to_keep_accli1])
betadisper(neutral_accli1, subset_meta_accli1$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_neutral_accli1_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_accli1 ~ Population*time_point,
        data = subset_meta_accli1 %>% arrange(match(Tube_code,labels(neutral_accli1))),
        permutations = 999,
        strata = subset_meta_accli1 %>% arrange(match(Tube_code,labels(neutral_accli1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise<-pairwise.adonis(neutral_accli1,subset_meta_accli1_arrange$Population_time, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_div_phylo_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_accli1 <- as.matrix(beta_q1p$S)
phylo_accli1 <- as.dist(phylo_accli1[rownames(phylo_accli1) %in% samples_to_keep_accli1,
               colnames(phylo_accli1) %in% samples_to_keep_accli1])
betadisper(phylo_accli1, subset_meta_accli1$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_phylo_accli1_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_accli1 ~ Population*time_point,
        data = subset_meta_accli1 %>% arrange(match(Tube_code,labels(phylo_accli1))),
        permutations = 999,
        strata = subset_meta_accli1 %>% arrange(match(Tube_code,labels(phylo_accli1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise<-pairwise.adonis(phylo_accli1,subset_meta_accli1_arrange$Population_time, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_div_func_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_accli1 <- as.matrix(beta_q1f$S)
func_accli1 <- as.dist(func_accli1[rownames(func_accli1) %in% samples_to_keep_accli1,
               colnames(func_accli1) %in% samples_to_keep_accli1])
betadisper(func_accli1, subset_meta_accli1$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_func_accli1_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_accli1 ~ Population*time_point,
        data = subset_meta_accli1 %>% arrange(match(Tube_code,labels(func_accli1))),
        permutations = 999,
        strata = subset_meta_accli1 %>% arrange(match(Tube_code,labels(func_accli1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_func_permanova_accli1_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise<-pairwise.adonis(func_accli1,subset_meta_accli1_arrange$Population_time, perm=999)
pairwise%>%
  tt()
```

```{r beta_neutral_nmds_accli1, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_accli1 <- richness_accli1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_accli1, by = c("sample" = "Tube_code"))

beta_neutral_nmds_accli1 <- neutral_accli1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_accli1, by = c("sample" = "Tube_code"))

beta_phylo_nmds_accli1 <- phylo_accli1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_accli1, by = join_by(sample == Tube_code))

beta_func_nmds_accli1 <- func_accli1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_accli1, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_accli1_plot, echo=FALSE, results=FALSE}
p0<-beta_richness_nmds_accli1 %>%
			group_by(individual) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, shape=time_point)) +
        scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p1<-beta_neutral_nmds_accli1 %>%
			group_by(individual) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, shape=time_point)) +
        scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
				theme_classic() +
				theme(legend.position="none")
  
p2<-beta_phylo_nmds_accli1 %>%
			group_by(individual) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, shape=time_point)) +
				scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p3<-beta_func_nmds_accli1 %>%
			group_by(individual) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=Population, shape=time_point)) +
				scale_color_manual(name="Population",
                     breaks=c("Cold_wet","Hot_dry"),
                     labels=c("Cold","Hot"),
                     values=c('#008080',"#d57d2c")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
				theme_classic()+
				theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_accli1_final, echo=FALSE, results=TRUE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```


### 4. Effect of FMT on microbiota community

#### Comparison between Acclimation vs Post-FMT1
##### Number of samples used

```{r beta_div_neutral_post3_samples, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(post3)
samples_to_keep_post3 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "5_Post-FMT1") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post3 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "5_Post-FMT1")

subset_meta_post3$type_time <- interaction(subset_meta_post3$type, subset_meta_post3$time_point)
```

##### Richness

```{r beta_div_richness_post3_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_post3 <- as.matrix(beta_q0n$S)
richness_post3 <- as.dist(richness_post3[rownames(richness_post3) %in% samples_to_keep_post3,
               colnames(richness_post3) %in% samples_to_keep_post3])
betadisper(richness_post3, subset_meta_post3$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_richness_post3_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post3 ~ Population*time_point,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(richness_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(richness_post3))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post3_8, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_post3_arrange <- column_to_rownames(subset_meta_post3, "Tube_code")
subset_meta_post3_arrange<-subset_meta_post3_arrange[labels(richness_post3),]

pairwise <- pairwise.adonis(richness_post3, subset_meta_post3_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_div_neutral_post3_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_post3 <- as.matrix(beta_q1n$S)
neutral_post3 <- as.dist(neutral_post3[rownames(neutral_post3) %in% samples_to_keep_post3,
               colnames(neutral_post3) %in% samples_to_keep_post3])
betadisper(neutral_post3, subset_meta_post3$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_neutral_post3_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post3 ~ Population*time_point,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(neutral_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(neutral_post3))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post3_9, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(neutral_post3, subset_meta_post3_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_div_phylo_post3_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_post3 <- as.matrix(beta_q1p$S)
phylo_post3 <- as.dist(phylo_post3[rownames(phylo_post3) %in% samples_to_keep_post3,
               colnames(phylo_post3) %in% samples_to_keep_post3])
betadisper(phylo_post3, subset_meta_post3$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_phylo_post3_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post3 ~ Population*time_point,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(phylo_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(phylo_post3))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post3_6, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(phylo_post3, subset_meta_post3_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_div_func_post3_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_post3 <- as.matrix(beta_q1f$S)
func_post3 <- as.dist(func_post3[rownames(func_post3) %in% samples_to_keep_post3,
               colnames(func_post3) %in% samples_to_keep_post3])
betadisper(func_post3, subset_meta_post3$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_func_post3_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_post3 ~ Population*time_point,
        data = subset_meta_post3 %>% arrange(match(Tube_code,labels(func_post3))),
        permutations = 999,
        strata = subset_meta_post3 %>% arrange(match(Tube_code,labels(func_post3))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post3_7, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(func_post3, subset_meta_post3_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

```{r beta_neutral_nmds_post3, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_post3 <- richness_post3 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post3, by = c("sample" = "Tube_code"))

beta_neutral_nmds_post3 <- neutral_post3 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post3, by = c("sample" = "Tube_code"))

beta_phylo_nmds_post3 <- phylo_post3 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post3, by = join_by(sample == Tube_code))

beta_func_nmds_post3 <- func_post3 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post3, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_post3_plot, echo=FALSE, results=FALSE}
p0<-beta_richness_nmds_post3 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p1<-beta_neutral_nmds_post3 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p2<-beta_phylo_nmds_post3 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p3<-beta_func_nmds_post3 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
  theme_classic()+
  theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_post3_final, echo=FALSE, results=TRUE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```

#### Comparison between Acclimation vs Post-FMT2

##### Number of samples used

```{r beta_div_neutral_post4_samples, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(post4)
samples_to_keep_post4 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "6_Post-FMT2") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post4 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "6_Post-FMT2")

subset_meta_post4$type_time <- interaction(subset_meta_post4$type, subset_meta_post4$time_point)
```

##### Richness

```{r beta_div_richness_post4_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_post4 <- as.matrix(beta_q0n$S)
richness_post4 <- as.dist(richness_post4[rownames(richness_post4) %in% samples_to_keep_post4,
               colnames(richness_post4) %in% samples_to_keep_post4])
betadisper(richness_post4, subset_meta_post4$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_richness_post4_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post4 ~ Population*time_point,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(richness_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(richness_post4))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post4_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_post4_arrange <- column_to_rownames(subset_meta_post4, "Tube_code")
subset_meta_post4_arrange<-subset_meta_post4_arrange[labels(richness_post4),]

pairwise <- pairwise.adonis(richness_post4, subset_meta_post4_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_div_neutral_post4_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_post4 <- as.matrix(beta_q1n$S)
neutral_post4 <- as.dist(neutral_post4[rownames(neutral_post4) %in% samples_to_keep_post4,
               colnames(neutral_post4) %in% samples_to_keep_post4])
betadisper(neutral_post4, subset_meta_post4$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_neutral_post4_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post4 ~ Population*time_point,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(neutral_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(neutral_post4))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post4_6, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(neutral_post4, subset_meta_post4_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_div_phylo_post4_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_post4 <- as.matrix(beta_q1p$S)
phylo_post4 <- as.dist(phylo_post4[rownames(phylo_post4) %in% samples_to_keep_post4,
               colnames(phylo_post4) %in% samples_to_keep_post4])
betadisper(phylo_post4, subset_meta_post4$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_phylo_post4_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post4 ~ Population*time_point,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(phylo_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(phylo_post4))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post4_7, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(phylo_post4, subset_meta_post4_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_div_func_post4_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_post4 <- as.matrix(beta_q1f$S)
func_post4 <- as.dist(func_post4[rownames(func_post4) %in% samples_to_keep_post4,
               colnames(func_post4) %in% samples_to_keep_post4])
betadisper(func_post4, subset_meta_post4$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_func_post4_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_post4 ~ Population*time_point,
        data = subset_meta_post4 %>% arrange(match(Tube_code,labels(func_post4))),
        permutations = 999,
        strata = subset_meta_post4 %>% arrange(match(Tube_code,labels(func_post4))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post4_8, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(func_post4, subset_meta_post4_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

```{r beta_neutral_nmds_post4, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_post4 <- richness_post4 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post4, by = c("sample" = "Tube_code"))

beta_neutral_nmds_post4 <- neutral_post4 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post4, by = c("sample" = "Tube_code"))

beta_phylo_nmds_post4 <- phylo_post4 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post4, by = join_by(sample == Tube_code))

beta_func_nmds_post4 <- func_post4 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post4, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_post4_plot, echo=FALSE, results=FALSE}
p0<-beta_richness_nmds_post4 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p1<-beta_neutral_nmds_post4 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p2<-beta_phylo_nmds_post4 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p3<-beta_func_nmds_post4 %>%
  group_by(type) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
  theme_classic()+
  theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_post4_final, echo=FALSE, results=TRUE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```

#### Comparison between Acclimation vs Post-FMT1 and Post-FMT2

##### Number of samples used

```{r beta_div_neutral_post6_samples, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(post6)
samples_to_keep_post6 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "6_Post-FMT2"| time_point == "5_Post-FMT1") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post6 <- sample_metadata %>%
  filter(time_point == "1_Acclimation"| time_point == "6_Post-FMT2"| time_point == "5_Post-FMT1")

subset_meta_post6$type_time <- interaction(subset_meta_post6$type, subset_meta_post6$time_point)
```

##### Richness

```{r beta_div_richness_post6_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_post6 <- as.matrix(beta_q0n$S)
richness_post6 <- as.dist(richness_post6[rownames(richness_post6) %in% samples_to_keep_post6,
               colnames(richness_post6) %in% samples_to_keep_post6])
betadisper(richness_post6, subset_meta_post6$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_richness_post6_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post6 ~ type*time_point,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(richness_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(richness_post6))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post6_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_post6_arrange <- column_to_rownames(subset_meta_post6, "Tube_code")
subset_meta_post6_arrange<-subset_meta_post6_arrange[labels(richness_post6),]

pairwise <- pairwise.adonis(richness_post6, subset_meta_post6_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_div_neutral_post6_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_post6 <- as.matrix(beta_q1n$S)
neutral_post6 <- as.dist(neutral_post6[rownames(neutral_post6) %in% samples_to_keep_post6,
               colnames(neutral_post6) %in% samples_to_keep_post6])
betadisper(neutral_post6, subset_meta_post6$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_neutral_post6_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post6 ~ type*time_point,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(neutral_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(neutral_post6))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post6_6, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(neutral_post6, subset_meta_post6_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_div_phylo_post6_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_post6 <- as.matrix(beta_q1p$S)
phylo_post6 <- as.dist(phylo_post6[rownames(phylo_post6) %in% samples_to_keep_post6,
               colnames(phylo_post6) %in% samples_to_keep_post6])
betadisper(phylo_post6, subset_meta_post6$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_phylo_post6_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post6 ~ type*time_point,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(phylo_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(phylo_post6))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post6_7, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(phylo_post6, subset_meta_post6_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_div_func_post6_5, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_post6 <- as.matrix(beta_q1f$S)
func_post6 <- as.dist(func_post6[rownames(func_post6) %in% samples_to_keep_post6,
               colnames(func_post6) %in% samples_to_keep_post6])
betadisper(func_post6, subset_meta_post6$Population) %>% permutest(., pairwise = TRUE)
```

```{r beta_div_func_post6_4, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_post6 ~ type*time_point,
        data = subset_meta_post6 %>% arrange(match(Tube_code,labels(func_post6))),
        permutations = 999,
        strata = subset_meta_post6 %>% arrange(match(Tube_code,labels(func_post6))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_div_pairwise_post6_8, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(func_post6, subset_meta_post6_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

```{r beta_neutral_nmds_post6, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_post6 <- richness_post6 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post6, by = c("sample" = "Tube_code"))

beta_neutral_nmds_post6 <- neutral_post6 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post6, by = c("sample" = "Tube_code"))

beta_phylo_nmds_post6 <- phylo_post6 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post6, by = join_by(sample == Tube_code))

beta_func_nmds_post6 <- func_post6 %>%
  metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
  scores() %>%
  as_tibble(., rownames = "sample") %>%
  left_join(subset_meta_post6, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_post6_plot, echo=FALSE, results=FALSE}
p0<-beta_richness_nmds_post6 %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p1<-beta_neutral_nmds_post6 %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p2<-beta_phylo_nmds_post6 %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
  theme_classic() +
  theme(legend.position="none")

p3<-beta_func_nmds_post6 %>%
  group_by(type, time_point) %>%
  mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
  mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
  scale_color_manual(name="Type",
                     breaks=c("Control", "Hot_control", "Treatment"),
                     labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                     values=c("#4477AA","#d57d2c","#76b183")) +
  geom_point(size=2) +
  geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
  labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
  theme_classic()+
  theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_post6_final, echo=FALSE, results=TRUE, fig.height=8, fig.width=10, fig.fullwidth=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```

### 5. Are there differences between the control and the treatment group?

#### After 1 week --> Post-FMT1
##### Number of samples used

```{r beta_div_neutral_treat1_samples_2, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(post1)
samples_to_keep_post1 <- sample_metadata %>%
  filter(time_point == "5_Post-FMT1") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post1 <- sample_metadata %>%
  filter(time_point == "5_Post-FMT1")
```

##### Richness

```{r beta_richness_permanova_post1_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_post1 <- as.matrix(beta_q0n$S)
richness_post1 <- as.dist(richness_post1[rownames(richness_post1) %in% samples_to_keep_post1,
               colnames(richness_post1) %in% samples_to_keep_post1])
betadisper(richness_post1, subset_meta_post1$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post1_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post1 ~ type,
        data = subset_meta_post1 %>% arrange(match(Tube_code,labels(richness_post1))),
        permutations = 999,
        strata = subset_meta_post1 %>% arrange(match(Tube_code,labels(richness_post1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post1_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_post1_arrange <- column_to_rownames(subset_meta_post1, "Tube_code")
subset_meta_post1_arrange<-subset_meta_post1_arrange[labels(richness_post1),]

pairwise <- pairwise.adonis(richness_post1, subset_meta_post1_arrange$type, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_neutral_permanova_post1_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_post1 <- as.matrix(beta_q1n$S)
neutral_post1 <- as.dist(neutral_post1[rownames(neutral_post1) %in% samples_to_keep_post1,
               colnames(neutral_post1) %in% samples_to_keep_post1])
betadisper(neutral_post1, subset_meta_post1$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post1_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post1 ~ type,
        data = subset_meta_post1 %>% arrange(match(Tube_code,labels(neutral_post1))),
        permutations = 999,
        strata = subset_meta_post1 %>% arrange(match(Tube_code,labels(neutral_post1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post1_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(neutral_post1, subset_meta_post1_arrange$type, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_phylo_permanova_post1_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_post1 <- as.matrix(beta_q1p$S)
phylo_post1 <- as.dist(phylo_post1[rownames(phylo_post1) %in% samples_to_keep_post1,
               colnames(phylo_post1) %in% samples_to_keep_post1])
betadisper(phylo_post1, subset_meta_post1$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_phylo_permanova_post1_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post1 ~ type,
        data = subset_meta_post1 %>% arrange(match(Tube_code,labels(phylo_post1))),
        permutations = 999,
        strata = subset_meta_post1 %>% arrange(match(Tube_code,labels(phylo_post1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post1_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(phylo_post1, subset_meta_post1_arrange$type, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_func_permanova_post1_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_post1 <- as.matrix(beta_q1f$S)
func_post1 <- as.dist(func_post1[rownames(func_post1) %in% samples_to_keep_post1,
               colnames(func_post1) %in% samples_to_keep_post1])
betadisper(func_post1, subset_meta_post1$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_func_permanova_post1_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_post1 ~ type,
        data = subset_meta_post1 %>% arrange(match(Tube_code,labels(func_post1))),
        permutations = 999,
        strata = subset_meta_post1 %>% arrange(match(Tube_code,labels(func_post1))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_func_permanova_post1_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(func_post1, subset_meta_post1_arrange$type, perm=999)
pairwise%>%
  tt()
```


```{r beta_neutral_nmds_post1, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_post1 <- richness_post1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post1, by = join_by(sample == Tube_code))

beta_neutral_nmds_post1 <- neutral_post1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post1, by = join_by(sample == Tube_code))

beta_phylogenetic_nmds_post1 <- phylo_post1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post1, by = join_by(sample == Tube_code))

beta_functional_nmds_post1 <- func_post1 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post1, by = join_by(sample == Tube_code))
```

```{r beta_neutral_nmds_post1_plot, eho=FALSE, results=FALSE}
p0<-beta_richness_nmds_post1 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
        scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p1<-beta_neutral_nmds_post1 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
        scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
				theme_classic() +
				theme(legend.position="none")
  
p2<-beta_phylogenetic_nmds_post1 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
				scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p3<-beta_functional_nmds_post1 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
				scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
				theme_classic()+
				theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_post1_final, fig.height=7, eho=FALSE, results=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```


#### After 2 weeks -->Post-FMT2

```{r beta_div_phylo_post2, echo=TRUE, results=FALSE}
post2 <- meta %>%
  filter(time_point == "6_Post-FMT2")

post2.counts <- temp_genome_counts[,which(colnames(temp_genome_counts) %in% rownames(post2))]
identical(sort(colnames(post2.counts)),sort(as.character(rownames(post2))))

post2_nmds <- sample_metadata %>%
  filter(time_point == "6_Post-FMT2")
```


##### Number of samples used

```{r beta_div_neutral_treat_samples_2, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(post2)
samples_to_keep_post2 <- sample_metadata %>%
  filter(time_point == "6_Post-FMT2") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post2 <- sample_metadata %>%
  filter(time_point == "6_Post-FMT2")
```

##### Richness

```{r beta_richness_permanova_post2_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_post2 <- as.matrix(beta_q0n$S)
richness_post2 <- as.dist(richness_post2[rownames(richness_post2) %in% samples_to_keep_post2,
               colnames(richness_post2) %in% samples_to_keep_post2])
betadisper(richness_post2, subset_meta_post2$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post2_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post2 ~ type,
        data = subset_meta_post2 %>% arrange(match(Tube_code,labels(richness_post2))),
        permutations = 999,
        strata = subset_meta_post2 %>% arrange(match(Tube_code,labels(richness_post2))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post2_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_post2_arrange <- column_to_rownames(subset_meta_post2, "Tube_code")
subset_meta_post2_arrange<-subset_meta_post2_arrange[labels(richness_post2),]

pairwise <- pairwise.adonis(richness_post2, subset_meta_post2_arrange$type, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_neutral_permanova_post2_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_post2 <- as.matrix(beta_q1n$S)
neutral_post2 <- as.dist(neutral_post2[rownames(neutral_post2) %in% samples_to_keep_post2,
               colnames(neutral_post2) %in% samples_to_keep_post2])
betadisper(neutral_post2, subset_meta_post2$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post2_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post2 ~ type,
        data = subset_meta_post2 %>% arrange(match(Tube_code,labels(neutral_post2))),
        permutations = 999,
        strata = subset_meta_post2 %>% arrange(match(Tube_code,labels(neutral_post2))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post2_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(neutral_post2, subset_meta_post2_arrange$type, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_phylo_permanova_post2_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_post2 <- as.matrix(beta_q1p$S)
phylo_post2 <- as.dist(phylo_post2[rownames(phylo_post2) %in% samples_to_keep_post2,
               colnames(phylo_post2) %in% samples_to_keep_post2])
betadisper(phylo_post2, subset_meta_post2$type) %>% permutest(., pairwise = TRUE)
```


```{r beta_phylo_permanova_post2_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post2 ~ type,
        data = subset_meta_post2 %>% arrange(match(Tube_code,labels(phylo_post2))),
        permutations = 999,
        strata = subset_meta_post2 %>% arrange(match(Tube_code,labels(phylo_post2))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post2_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(phylo_post2, subset_meta_post2_arrange$type, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_func_permanova_post2_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_post2 <- as.matrix(beta_q1f$S)
func_post2 <- as.dist(func_post2[rownames(func_post2) %in% samples_to_keep_post2,
               colnames(func_post2) %in% samples_to_keep_post2])
betadisper(func_post2, subset_meta_post2$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_func_permanova_post2_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_post2 ~ type,
        data = subset_meta_post2 %>% arrange(match(Tube_code,labels(func_post2))),
        permutations = 999,
        strata = subset_meta_post2 %>% arrange(match(Tube_code,labels(func_post2))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_func_permanova_post2_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(func_post2, subset_meta_post2_arrange$type, perm=999)
pairwise%>%
  tt()
```


```{r beta_neutral_nmds_post2, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_post2 <- richness_post2 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post2, by = join_by(sample == Tube_code))

beta_neutral_nmds_post2 <- neutral_post2 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post2, by = join_by(sample == Tube_code))

beta_phylogenetic_nmds_post2 <- phylo_post2 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post2, by = join_by(sample == Tube_code))

beta_functional_nmds_post2 <- func_post2 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post2, by = join_by(sample == Tube_code))
```


```{r beta_neutral_nmds_post2_plot, eho=FALSE, results=FALSE}
p0<-beta_richness_nmds_post2 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
        scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p1<-beta_neutral_nmds_post2 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
        scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
				theme_classic() +
				theme(legend.position="none")
  
p2<-beta_phylogenetic_nmds_post2 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
				scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p3<-beta_functional_nmds_post2 %>%
			group_by(type) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type)) +
				scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
				theme_classic()+
				theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_post2_final, fig.height=7, eho=FALSE, results=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```

#### Post1 vs Post2

```{r beta_div_phylo_post5, echo=TRUE, results=FALSE}
post5 <- meta %>%
  filter(time_point == "6_Post-FMT2" | time_point == "5_Post-FMT1")

post5.counts <- temp_genome_counts[,which(colnames(temp_genome_counts) %in% rownames(post5))]
identical(sort(colnames(post5.counts)),sort(as.character(rownames(post5))))

post5_nmds <- sample_metadata %>%
  filter(time_point == "6_Post-FMT2"| time_point == "5_Post-FMT1")
```


##### Number of samples used

```{r post5_samples_, echo=FALSE, results = TRUE, message=FALSE, warning=FALSE, comments=FALSE}
nrow(post5)
samples_to_keep_post5 <- sample_metadata %>%
  filter(time_point == "6_Post-FMT2"| time_point == "5_Post-FMT1") %>% 
  select(Tube_code) %>% 
  pull()
subset_meta_post5 <- sample_metadata %>%
  filter(time_point == "6_Post-FMT2"| time_point == "5_Post-FMT1")

subset_meta_post5$type_time <- interaction(subset_meta_post5$type, subset_meta_post5$time_point)
```

##### Richness

```{r beta_richness_permanova_post5_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
richness_post5 <- as.matrix(beta_q0n$S)
richness_post5 <- as.dist(richness_post5[rownames(richness_post5) %in% samples_to_keep_post5,
               colnames(richness_post5) %in% samples_to_keep_post5])
betadisper(richness_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_richness_permanova_post5_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(richness_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(richness_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(richness_post5))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_richness_permanova_post5_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
#Arrange of metadata dataframe
subset_meta_post5_arrange <- column_to_rownames(subset_meta_post5, "Tube_code")
subset_meta_post5_arrange<-subset_meta_post5_arrange[labels(richness_post5),]

pairwise <- pairwise.adonis(richness_post5, subset_meta_post5_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Neutral

```{r beta_neutral_permanova_post5_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
neutral_post5 <- as.matrix(beta_q1n$S)
neutral_post5 <- as.dist(neutral_post5[rownames(neutral_post5) %in% samples_to_keep_post5,
               colnames(neutral_post5) %in% samples_to_keep_post5])
betadisper(neutral_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_neutral_permanova_post5_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(neutral_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(neutral_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(neutral_post5))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_neutral_permanova_post5_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(neutral_post5, subset_meta_post5_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Phylogenetic

```{r beta_phylo_permanova_post5_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
phylo_post5 <- as.matrix(beta_q1p$S)
phylo_post5 <- as.dist(phylo_post5[rownames(phylo_post5) %in% samples_to_keep_post5,
               colnames(phylo_post5) %in% samples_to_keep_post5])
betadisper(phylo_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```


```{r beta_phylo_permanova_post5_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(phylo_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(phylo_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(phylo_post5))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_phylo_permanova_post5_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(phylo_post5, subset_meta_post5_arrange$type_time, perm=999)
pairwise%>%
  tt()
```

##### Functional

```{r beta_func_permanova_post5_2, echo=TRUE, warning=FALSE, comments="", message=FALSE}
func_post5 <- as.matrix(beta_q1f$S)
func_post5 <- as.dist(func_post5[rownames(func_post5) %in% samples_to_keep_post5,
               colnames(func_post5) %in% samples_to_keep_post5])
betadisper(func_post5, subset_meta_post5$type) %>% permutest(., pairwise = TRUE)
```

```{r beta_func_permanova_post5_1, echo=TRUE, warning=FALSE, comments="", message=FALSE}
adonis2(func_post5 ~ type*time_point,
        data = subset_meta_post5 %>% arrange(match(Tube_code,labels(func_post5))),
        permutations = 999,
        strata = subset_meta_post5 %>% arrange(match(Tube_code,labels(func_post5))) %>% pull(individual)) %>%
        broom::tidy() %>%
        tt()
```

```{r beta_func_permanova_post5_3, echo=TRUE, warning=FALSE, comments="", message=FALSE}
pairwise <- pairwise.adonis(func_post5, subset_meta_post5_arrange$type_time, perm=999)
pairwise%>%
  tt()
```


```{r beta_neutral_nmds_post5, echo=TRUE, warning=FALSE, comments="", message=FALSE, results="hide"}
beta_richness_nmds_post5 <- richness_post5 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post5, by = join_by(sample == Tube_code))

beta_neutral_nmds_post5 <- neutral_post5 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post5, by = join_by(sample == Tube_code))

beta_phylogenetic_nmds_post5 <- phylo_post5 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post5, by = join_by(sample == Tube_code))

beta_functional_nmds_post5 <- func_post5 %>%
				metaMDS(.,trymax = 500, k=2, verbosity=FALSE) %>%
				scores() %>%
				as_tibble(., rownames = "sample") %>%
				left_join(subset_meta_post5, by = join_by(sample == Tube_code))
```


```{r beta_neutral_nmds_post5_plot, eho=FALSE, results=FALSE}
p0<-beta_richness_nmds_post5 %>%
			group_by(type, time_point) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
        scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Richness beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p1<-beta_neutral_nmds_post5 %>%
			group_by(type, time_point) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
        scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y = "NMDS2", x="NMDS1 \n Neutral beta diversity") +
				theme_classic() +
				theme(legend.position="none")
  
p2<-beta_phylogenetic_nmds_post5 %>%
			group_by(type, time_point) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
				scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Phylogenetic beta diversity") +
				theme_classic() +
				theme(legend.position="none")

p3<-beta_functional_nmds_post5 %>%
			group_by(type, time_point) %>%
			mutate(x_cen = mean(NMDS1, na.rm = TRUE)) %>%
			mutate(y_cen = mean(NMDS2, na.rm = TRUE)) %>%
			ungroup() %>%
			ggplot(., aes(x=NMDS1,y=NMDS2, color=type, shape=time_point)) +
				scale_color_manual(name="Type",
                       breaks=c("Control", "Hot_control", "Treatment"),
                       labels=c("Cold-Cold", "Hot-Hot", "Cold-Hot"),
                       values=c("#4477AA","#d57d2c","#76b183")) +
				geom_point(size=2) +
				geom_segment(aes(x=x_cen, y=y_cen, xend=NMDS1, yend=NMDS2), alpha=0.2) +
        labs(y= element_blank (), x="NMDS1 \n Functional beta diversity") +
				theme_classic()+
				theme(legend.position="none")
```

```{r beta_neutral_nmds_plot_post5_final, fig.height=7, eho=FALSE, results=TRUE}
ggarrange(p0, p1, p2, p3, ncol=2, nrow=2, common.legend = TRUE, legend="right")
```
